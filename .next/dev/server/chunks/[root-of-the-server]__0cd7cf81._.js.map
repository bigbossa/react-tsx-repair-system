{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/bigboss/react-tsx-repair-system/react-tsx-repair-system/lib/db.ts"],"sourcesContent":["import { Pool } from 'pg'\r\n\r\n// User Login Database (useryc)\r\nconsole.log('User Database Configuration:', {\r\n  host: process.env.DBLG_HOST,\r\n  port: process.env.DBLG_PORT,\r\n  database: process.env.DBLG_NAME,\r\n  user: process.env.DBLG_USER,\r\n  passwordSet: !!process.env.DBLG_PASSWORD\r\n})\r\n\r\nconst poolLogin = new Pool({\r\n  host: process.env.DBLG_HOST,\r\n  port: parseInt(process.env.DBLG_PORT || '5432'),\r\n  database: process.env.DBLG_NAME,\r\n  user: process.env.DBLG_USER,\r\n  password: process.env.DBLG_PASSWORD,\r\n  connectionTimeoutMillis: 10000,\r\n  idleTimeoutMillis: 30000,\r\n  max: 10,\r\n})\r\n\r\n// Repair Request Database (RepairRequest)\r\nconsole.log('Repair Database Configuration:', {\r\n  host: process.env.DBRE_HOST,\r\n  port: process.env.DBRE_PORT,\r\n  database: process.env.DBRE_NAME,\r\n  user: process.env.DBRE_USER,\r\n  passwordSet: !!process.env.DBRE_PASSWORD\r\n})\r\n\r\nconst poolRepair = new Pool({\r\n  host: process.env.DBRE_HOST,\r\n  port: parseInt(process.env.DBRE_PORT || '5432'),\r\n  database: process.env.DBRE_NAME,\r\n  user: process.env.DBRE_USER,\r\n  password: process.env.DBRE_PASSWORD,\r\n  connectionTimeoutMillis: 10000,\r\n  idleTimeoutMillis: 30000,\r\n  max: 10,\r\n})\r\n\r\n// Test connections on startup\r\npoolLogin.on('connect', () => {\r\n  console.log('User Database connected successfully')\r\n})\r\n\r\npoolLogin.on('error', (err) => {\r\n  console.error('Unexpected user database error:', err)\r\n})\r\n\r\npoolRepair.on('connect', () => {\r\n  console.log('Repair Database connected successfully')\r\n})\r\n\r\npoolRepair.on('error', (err) => {\r\n  console.error('Unexpected repair database error:', err)\r\n})\r\n\r\nexport async function query(text: string, params?: any[]) {\r\n  const start = Date.now()\r\n  try {\r\n    const res = await poolLogin.query(text, params)\r\n    const duration = Date.now() - start\r\n    console.log('Query executed successfully', { duration, rows: res.rowCount })\r\n    return res\r\n  } catch (error) {\r\n    console.error('Database query error:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\nexport async function queryRepair(text: string, params?: any[]) {\r\n  const start = Date.now()\r\n  try {\r\n    const res = await poolRepair.query(text, params)\r\n    const duration = Date.now() - start\r\n    console.log('Repair DB Query executed successfully', { duration, rows: res.rowCount })\r\n    return res\r\n  } catch (error) {\r\n    console.error('Repair database query error:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\nexport { poolLogin as default, poolRepair }\r\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;;;;AAEA,+BAA+B;AAC/B,QAAQ,GAAG,CAAC,gCAAgC;IAC1C,IAAI;IACJ,IAAI;IACJ,QAAQ;IACR,IAAI;IACJ,aAAa,CAAC;AAChB;AAEA,MAAM,YAAY,IAAI,4GAAI,CAAC;IACzB,IAAI;IACJ,MAAM,SAAS,4CAAyB;IACxC,QAAQ;IACR,IAAI;IACJ,QAAQ;IACR,yBAAyB;IACzB,mBAAmB;IACnB,KAAK;AACP;AAEA,0CAA0C;AAC1C,QAAQ,GAAG,CAAC,kCAAkC;IAC5C,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,UAAU,QAAQ,GAAG,CAAC,SAAS;IAC/B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,aAAa,CAAC,CAAC,QAAQ,GAAG,CAAC,aAAa;AAC1C;AAEA,MAAM,aAAa,IAAI,4GAAI,CAAC;IAC1B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,MAAM,SAAS,QAAQ,GAAG,CAAC,SAAS,IAAI;IACxC,UAAU,QAAQ,GAAG,CAAC,SAAS;IAC/B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,UAAU,QAAQ,GAAG,CAAC,aAAa;IACnC,yBAAyB;IACzB,mBAAmB;IACnB,KAAK;AACP;AAEA,8BAA8B;AAC9B,UAAU,EAAE,CAAC,WAAW;IACtB,QAAQ,GAAG,CAAC;AACd;AAEA,UAAU,EAAE,CAAC,SAAS,CAAC;IACrB,QAAQ,KAAK,CAAC,mCAAmC;AACnD;AAEA,WAAW,EAAE,CAAC,WAAW;IACvB,QAAQ,GAAG,CAAC;AACd;AAEA,WAAW,EAAE,CAAC,SAAS,CAAC;IACtB,QAAQ,KAAK,CAAC,qCAAqC;AACrD;AAEO,eAAe,MAAM,IAAY,EAAE,MAAc;IACtD,MAAM,QAAQ,KAAK,GAAG;IACtB,IAAI;QACF,MAAM,MAAM,MAAM,UAAU,KAAK,CAAC,MAAM;QACxC,MAAM,WAAW,KAAK,GAAG,KAAK;QAC9B,QAAQ,GAAG,CAAC,+BAA+B;YAAE;YAAU,MAAM,IAAI,QAAQ;QAAC;QAC1E,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,MAAM;IACR;AACF;AAEO,eAAe,YAAY,IAAY,EAAE,MAAc;IAC5D,MAAM,QAAQ,KAAK,GAAG;IACtB,IAAI;QACF,MAAM,MAAM,MAAM,WAAW,KAAK,CAAC,MAAM;QACzC,MAAM,WAAW,KAAK,GAAG,KAAK;QAC9B,QAAQ,GAAG,CAAC,yCAAyC;YAAE;YAAU,MAAM,IAAI,QAAQ;QAAC;QACpF,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,MAAM;IACR;AACF"}},
    {"offset": {"line": 159, "column": 0}, "map": {"version":3,"sources":["file:///C:/bigboss/react-tsx-repair-system/react-tsx-repair-system/lib/line-notify.ts"],"sourcesContent":["/**\r\n * LINE Official Account Integration (Messaging API)\r\n * ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô LINE Official Account\r\n */\r\n\r\nconst LINE_MESSAGING_API = 'https://api.line.me/v2/bot/message'\r\n\r\ninterface LineMessageOptions {\r\n  message: string\r\n  imageUrl?: string\r\n  userId?: string // ‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô (optional)\r\n}\r\n\r\ninterface FlexMessage {\r\n  type: string\r\n  altText: string\r\n  contents: any\r\n}\r\n\r\n/**\r\n * ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô\r\n */\r\nfunction createFlexMessage(\r\n  title: string, \r\n  details: { label: string; value: string }[], \r\n  color: string = '#06C755',\r\n  requestId?: string,\r\n  currentStatus?: string\r\n): FlexMessage {\r\n  const contents: any = {\r\n    type: 'bubble',\r\n    header: {\r\n      type: 'box',\r\n      layout: 'vertical',\r\n      contents: [\r\n        {\r\n          type: 'text',\r\n          text: title,\r\n          color: '#ffffff',\r\n          weight: 'bold',\r\n          size: 'lg'\r\n        }\r\n      ],\r\n      backgroundColor: color,\r\n      paddingAll: '15px'\r\n    },\r\n    body: {\r\n      type: 'box',\r\n      layout: 'vertical',\r\n      contents: details.map(detail => ({\r\n        type: 'box',\r\n        layout: 'vertical',\r\n        contents: [\r\n          {\r\n            type: 'text',\r\n            text: detail.label,\r\n            color: '#999999',\r\n            size: 'sm',\r\n            margin: 'md'\r\n          },\r\n          {\r\n            type: 'text',\r\n            text: detail.value,\r\n            color: '#333333',\r\n            size: 'md',\r\n            weight: 'bold',\r\n            wrap: true\r\n          }\r\n        ],\r\n        margin: 'lg'\r\n      })),\r\n      paddingAll: '20px'\r\n    }\r\n  }\r\n\r\n  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ requestId\r\n  if (requestId) {\r\n    const buttons: any[] = []\r\n    \r\n    // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ \"‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£\" (0) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° \"‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô\"\r\n    if (currentStatus === '0') {\r\n      buttons.push({\r\n        type: 'button',\r\n        action: {\r\n          type: 'uri',\r\n          label: '‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô',\r\n          uri: `${process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000'}/dashboard?ticket=${requestId}&action=accept`\r\n        },\r\n        style: 'primary',\r\n        color: '#06C755',\r\n        height: 'sm'\r\n      })\r\n    }\r\n    \r\n    // ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡∏°‡∏≠\r\n    buttons.push({\r\n      type: 'button',\r\n      action: {\r\n        type: 'uri',\r\n        label: 'üëÅÔ∏è ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î',\r\n        uri: `${process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000'}/dashboard?ticket=${requestId}`\r\n      },\r\n      style: 'link',\r\n      height: 'sm'\r\n    })\r\n    \r\n    if (buttons.length > 0) {\r\n      contents.footer = {\r\n        type: 'box',\r\n        layout: 'vertical',\r\n        contents: buttons,\r\n        spacing: 'sm',\r\n        paddingAll: '20px'\r\n      }\r\n    }\r\n  }\r\n\r\n  return {\r\n    type: 'flex',\r\n    altText: title,\r\n    contents\r\n  }\r\n}\r\n\r\n/**\r\n * ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô LINE Official Account (Push Message)\r\n * @param to - User ID ‡∏´‡∏£‡∏∑‡∏≠ Group ID ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á\r\n * @param messages - Array ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á\r\n * @returns Promise<boolean> - ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà\r\n */\r\nexport async function sendPushMessage(to: string, messages: any[]): Promise<boolean> {\r\n  const channelAccessToken = process.env.LINE_CHANNEL_ACCESS_TOKEN\r\n\r\n  if (!channelAccessToken) {\r\n    console.warn('LINE_CHANNEL_ACCESS_TOKEN is not configured')\r\n    return false\r\n  }\r\n\r\n  try {\r\n    const response = await fetch(`${LINE_MESSAGING_API}/push`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Authorization': `Bearer ${channelAccessToken}`,\r\n      },\r\n      body: JSON.stringify({\r\n        to,\r\n        messages\r\n      }),\r\n    })\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text()\r\n      console.error('LINE Messaging API error:', response.status, errorText)\r\n      return false\r\n    }\r\n\r\n    console.log('LINE message sent successfully')\r\n    return true\r\n  } catch (error) {\r\n    console.error('Failed to send LINE message:', error)\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ö‡∏ö Broadcast (‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ö Bot)\r\n * @param messages - Array ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á\r\n * @returns Promise<boolean> - ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà\r\n */\r\nasync function sendBroadcastMessage(messages: any[]): Promise<boolean> {\r\n  const channelAccessToken = process.env.LINE_CHANNEL_ACCESS_TOKEN\r\n\r\n  if (!channelAccessToken) {\r\n    console.warn('LINE_CHANNEL_ACCESS_TOKEN is not configured')\r\n    return false\r\n  }\r\n\r\n  try {\r\n    const response = await fetch(`${LINE_MESSAGING_API}/broadcast`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Authorization': `Bearer ${channelAccessToken}`,\r\n      },\r\n      body: JSON.stringify({\r\n        messages\r\n      }),\r\n    })\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text()\r\n      console.error('LINE Broadcast API error:', response.status, errorText)\r\n      return false\r\n    }\r\n\r\n    console.log('LINE broadcast sent successfully')\r\n    return true\r\n  } catch (error) {\r\n    console.error('Failed to send LINE broadcast:', error)\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà\r\n */\r\nexport async function notifyNewRepairRequest(ticket: {\r\n  request_id: string\r\n  asset_id: string\r\n  username: string\r\n  work: string\r\n  type_of_work: string\r\n  detail_work: string\r\n  created_at?: Date\r\n}): Promise<boolean> {\r\n  const dateStr = ticket.created_at \r\n    ? new Date(ticket.created_at).toLocaleString('th-TH', { \r\n        timeZone: 'Asia/Bangkok',\r\n        year: 'numeric',\r\n        month: '2-digit',\r\n        day: '2-digit',\r\n        hour: '2-digit',\r\n        minute: '2-digit'\r\n      })\r\n    : new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })\r\n\r\n  // ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô\r\n  const flexMessage = createFlexMessage(\r\n    'üîî ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà!',\r\n    [\r\n      { label: '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏Ç‡∏≠', value: ticket.request_id },\r\n      { label: '‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á', value: ticket.username },\r\n      { label: '‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô', value: ticket.asset_id },\r\n      { label: '‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô', value: ticket.work },\r\n      { label: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó', value: ticket.type_of_work },\r\n      { label: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', value: ticket.detail_work },\r\n      { label: '‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤', value: dateStr }\r\n    ],\r\n    '#06C755',\r\n    ticket.request_id,\r\n    '0' // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏∑‡∏≠ \"‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£\" (0)\r\n  )\r\n\r\n  // ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö Broadcast (‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ö Bot)\r\n  const adminUserId = process.env.LINE_ADMIN_USER_ID\r\n  \r\n  if (adminUserId) {\r\n    // ‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á Admin ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô\r\n    return sendPushMessage(adminUserId, [flexMessage])\r\n  } else {\r\n    // ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö Broadcast ‡∏ñ‡∏∂‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô\r\n    return sendBroadcastMessage([flexMessage])\r\n  }\r\n}\r\n\r\n/**\r\n * ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå\r\n */\r\nexport async function notifyNewEquipmentRequest(req: {\r\n  request_id: string\r\n  username: string\r\n  equipment: string\r\n  detail: string\r\n  created_at?: Date\r\n}): Promise<boolean> {\r\n  const dateStr = req.created_at \r\n    ? new Date(req.created_at).toLocaleString('th-TH', { \r\n        timeZone: 'Asia/Bangkok',\r\n        year: 'numeric',\r\n        month: '2-digit',\r\n        day: '2-digit',\r\n        hour: '2-digit',\r\n        minute: '2-digit'\r\n      })\r\n    : new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })\r\n\r\n  const flexMessage = createFlexMessage(\r\n    'üßæ ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà',\r\n    [\r\n      { label: '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏Ç‡∏≠', value: req.request_id },\r\n      { label: '‡∏ú‡∏π‡πâ‡∏Ç‡∏≠', value: req.username },\r\n      { label: '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', value: req.equipment || '-' },\r\n      { label: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', value: req.detail || '-' },\r\n      { label: '‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤', value: dateStr }\r\n    ],\r\n    '#0EA5E9', // light blue\r\n    req.request_id,\r\n    '0'\r\n  )\r\n\r\n  const adminUserId = process.env.LINE_ADMIN_USER_ID\r\n\r\n  if (adminUserId) {\r\n    return sendPushMessage(adminUserId, [flexMessage])\r\n  } else {\r\n    return sendBroadcastMessage([flexMessage])\r\n  }\r\n}\r\n\r\n/**\r\n * ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô\r\n */\r\nexport async function notifyStatusChange(ticket: {\r\n  request_id: string\r\n  username: string\r\n  oldStatus: string\r\n  newStatus: string\r\n  lineUserId?: string // User ID ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô\r\n}): Promise<boolean> {\r\n  const statusMap: { [key: string]: string } = {\r\n    '0': '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',\r\n    '1': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',\r\n    '2': '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',\r\n    '3': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',\r\n    '4': '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô'\r\n  }\r\n\r\n  const statusEmoji: { [key: string]: string } = {\r\n    '0': '‚è≥',\r\n    '1': 'üîß',\r\n    '2': '‚úÖ',\r\n    '3': '‚ùå',\r\n    '4': 'üìã'\r\n  }\r\n\r\n  const statusColor: { [key: string]: string } = {\r\n    '0': '#FFA500',\r\n    '1': '#0084FF',\r\n    '2': '#06C755',\r\n    '3': '#999999',\r\n    '4': '#FFD700'\r\n  }\r\n\r\n  const dateStr = new Date().toLocaleString('th-TH', { \r\n    timeZone: 'Asia/Bangkok',\r\n    year: 'numeric',\r\n    month: '2-digit',\r\n    day: '2-digit',\r\n    hour: '2-digit',\r\n    minute: '2-digit'\r\n  })\r\n\r\n  const oldStatusText = statusMap[ticket.oldStatus] || ticket.oldStatus\r\n  const newStatusText = statusMap[ticket.newStatus] || ticket.newStatus\r\n  const emoji = statusEmoji[ticket.newStatus] || 'üîÑ'\r\n  const color = statusColor[ticket.newStatus] || '#0084FF'\r\n\r\n  // ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏° (‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)\r\n  const flexMessage = createFlexMessage(\r\n    `${emoji} ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${newStatusText}`,\r\n    [\r\n      { label: '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏Ç‡∏≠', value: ticket.request_id },\r\n      { label: '‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á', value: ticket.username },\r\n      { label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏°', value: `${statusEmoji[ticket.oldStatus] || ''}  ${oldStatusText}` },\r\n      { label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà', value: `${emoji} ${newStatusText}` },\r\n      { label: '‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤', value: dateStr }\r\n    ],\r\n    color,\r\n    ticket.request_id,\r\n    ticket.newStatus // ‡∏™‡πà‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°\r\n  )\r\n\r\n  // ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö Broadcast (‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô)\r\n  const adminUserId = process.env.LINE_ADMIN_USER_ID\r\n  \r\n  if (ticket.lineUserId) {\r\n    // ‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô\r\n    return sendPushMessage(ticket.lineUserId, [flexMessage])\r\n  } else if (adminUserId) {\r\n    // ‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á Admin\r\n    return sendPushMessage(adminUserId, [flexMessage])\r\n  } else {\r\n    // ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö Broadcast\r\n    return sendBroadcastMessage([flexMessage])\r\n  }\r\n}\r\n\r\n/**\r\n * ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à‡∏Å‡∏≤‡∏£‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á\r\n */\r\nexport async function sendMaintenanceFeedbackLink(params: {\r\n  asset_code: string\r\n  device_name: string\r\n  user_name: string\r\n  checked_by: string\r\n  feedbackUrl: string\r\n  lineUserId?: string\r\n}): Promise<boolean> {\r\n  const dateStr = new Date().toLocaleString('th-TH', { \r\n    timeZone: 'Asia/Bangkok',\r\n    year: 'numeric',\r\n    month: '2-digit',\r\n    day: '2-digit',\r\n    hour: '2-digit',\r\n    minute: '2-digit'\r\n  })\r\n\r\n  // ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message ‡πÅ‡∏ö‡∏ö‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô\r\n  const flexMessage: FlexMessage = {\r\n    type: 'flex',\r\n    altText: `‚úÖ ‡∏Å‡∏≤‡∏£‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤ ${params.asset_code} ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à`,\r\n    contents: {\r\n      type: 'bubble',\r\n      hero: {\r\n        type: 'box',\r\n        layout: 'vertical',\r\n        contents: [\r\n          {\r\n            type: 'text',\r\n            text: '‚úÖ MA ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',\r\n            color: '#ffffff',\r\n            size: 'xl',\r\n            weight: 'bold',\r\n            align: 'center'\r\n          },\r\n          {\r\n            type: 'text',\r\n            text: '‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏à‡∏≤‡∏Å‡∏ó‡πà‡∏≤‡∏ô',\r\n            color: '#ffffff',\r\n            size: 'sm',\r\n            align: 'center',\r\n            margin: 'sm'\r\n          }\r\n        ],\r\n        backgroundColor: '#06C755',\r\n        paddingAll: '20px'\r\n      },\r\n      body: {\r\n        type: 'box',\r\n        layout: 'vertical',\r\n        contents: [\r\n          {\r\n            type: 'box',\r\n            layout: 'vertical',\r\n            contents: [\r\n              {\r\n                type: 'text',\r\n                text: '‡∏Å‡∏≤‡∏£‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß',\r\n                size: 'md',\r\n                color: '#111111',\r\n                wrap: true,\r\n                weight: 'bold'\r\n              }\r\n            ],\r\n            margin: 'none'\r\n          },\r\n          {\r\n            type: 'separator',\r\n            margin: 'lg'\r\n          },\r\n          {\r\n            type: 'box',\r\n            layout: 'vertical',\r\n            margin: 'lg',\r\n            spacing: 'sm',\r\n            contents: [\r\n              {\r\n                type: 'box',\r\n                layout: 'baseline',\r\n                spacing: 'sm',\r\n                contents: [\r\n                  {\r\n                    type: 'text',\r\n                    text: 'üñ•Ô∏è ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:',\r\n                    color: '#666666',\r\n                    size: 'sm',\r\n                    flex: 2\r\n                  },\r\n                  {\r\n                    type: 'text',\r\n                    text: params.device_name,\r\n                    wrap: true,\r\n                    color: '#111111',\r\n                    size: 'sm',\r\n                    flex: 3,\r\n                    weight: 'bold'\r\n                  }\r\n                ]\r\n              },\r\n              {\r\n                type: 'box',\r\n                layout: 'baseline',\r\n                spacing: 'sm',\r\n                contents: [\r\n                  {\r\n                    type: 'text',\r\n                    text: 'üè∑Ô∏è ‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô:',\r\n                    color: '#666666',\r\n                    size: 'sm',\r\n                    flex: 2\r\n                  },\r\n                  {\r\n                    type: 'text',\r\n                    text: params.asset_code,\r\n                    wrap: true,\r\n                    color: '#111111',\r\n                    size: 'sm',\r\n                    flex: 3,\r\n                    weight: 'bold'\r\n                  }\r\n                ]\r\n              },\r\n              {\r\n                type: 'box',\r\n                layout: 'baseline',\r\n                spacing: 'sm',\r\n                contents: [\r\n                  {\r\n                    type: 'text',\r\n                    text: 'üë§ ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á:',\r\n                    color: '#666666',\r\n                    size: 'sm',\r\n                    flex: 2\r\n                  },\r\n                  {\r\n                    type: 'text',\r\n                    text: params.user_name,\r\n                    wrap: true,\r\n                    color: '#111111',\r\n                    size: 'sm',\r\n                    flex: 3\r\n                  }\r\n                ]\r\n              },\r\n              {\r\n                type: 'box',\r\n                layout: 'baseline',\r\n                spacing: 'sm',\r\n                contents: [\r\n                  {\r\n                    type: 'text',\r\n                    text: 'üîß ‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£:',\r\n                    color: '#666666',\r\n                    size: 'sm',\r\n                    flex: 2\r\n                  },\r\n                  {\r\n                    type: 'text',\r\n                    text: params.checked_by,\r\n                    wrap: true,\r\n                    color: '#111111',\r\n                    size: 'sm',\r\n                    flex: 3\r\n                  }\r\n                ]\r\n              },\r\n              {\r\n                type: 'box',\r\n                layout: 'baseline',\r\n                spacing: 'sm',\r\n                contents: [\r\n                  {\r\n                    type: 'text',\r\n                    text: 'üìÖ ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤:',\r\n                    color: '#666666',\r\n                    size: 'sm',\r\n                    flex: 2\r\n                  },\r\n                  {\r\n                    type: 'text',\r\n                    text: dateStr,\r\n                    wrap: true,\r\n                    color: '#111111',\r\n                    size: 'sm',\r\n                    flex: 3\r\n                  }\r\n                ]\r\n              }\r\n            ]\r\n          },\r\n          {\r\n            type: 'box',\r\n            layout: 'vertical',\r\n            contents: [\r\n              {\r\n                type: 'text',\r\n                text: '‚≠ê ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à',\r\n                size: 'sm',\r\n                color: '#06C755',\r\n                weight: 'bold',\r\n                align: 'center'\r\n              }\r\n            ],\r\n            margin: 'lg',\r\n            paddingAll: '10px',\r\n            backgroundColor: '#E8F5E9',\r\n            cornerRadius: '10px'\r\n          }\r\n        ]\r\n      },\r\n      footer: {\r\n        type: 'box',\r\n        layout: 'vertical',\r\n        spacing: 'sm',\r\n        contents: [\r\n          {\r\n            type: 'button',\r\n            style: 'primary',\r\n            height: 'sm',\r\n            action: {\r\n              type: 'uri',\r\n              label: 'üìã ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à',\r\n              uri: params.feedbackUrl\r\n            },\r\n            color: '#06C755'\r\n          },\r\n          {\r\n            type: 'box',\r\n            layout: 'vertical',\r\n            contents: [\r\n              {\r\n                type: 'text',\r\n                text: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤',\r\n                size: 'xxs',\r\n                color: '#999999',\r\n                align: 'center'\r\n              }\r\n            ],\r\n            margin: 'sm'\r\n          }\r\n        ],\r\n        flex: 0\r\n      }\r\n    }\r\n  }\r\n\r\n  // ‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á\r\n  if (params.lineUserId) {\r\n    return sendPushMessage(params.lineUserId, [flexMessage])\r\n  } else {\r\n    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ LINE User ID ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö broadcast (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö)\r\n    console.warn('No LINE User ID provided, sending as broadcast')\r\n    return sendBroadcastMessage([flexMessage])\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 764, "column": 0}, "map": {"version":3,"sources":["file:///C:/bigboss/react-tsx-repair-system/react-tsx-repair-system/app/api/tickets/route.ts"],"sourcesContent":["import { queryRepair } from \"@/lib/db\"\nimport { type NextRequest, NextResponse } from \"next/server\"\nimport { notifyNewRepairRequest, notifyNewEquipmentRequest } from \"@/lib/line-notify\"\n\nfunction validateTicketPayload(data: any) {\n  const errors: string[] = []\n  const formType = data?.formType || 'repair'\n\n  const str = (v: any) => (typeof v === 'string' ? v.trim() : '')\n\n  const username = str(data?.username)\n  if (!username) errors.push('username is required')\n\n  if (formType === 'repair') {\n    const assetId = str(data?.asset_id)\n    if (!assetId) errors.push('asset_id is required for repair form')\n    const work = str(data?.work)\n    if (!work) errors.push('work is required for repair form')\n  } else if (formType === 'request') {\n    const equipment = str(data?.work)\n    if (!equipment) errors.push('equipment (work) is required for request form')\n    const detail = str(data?.Ref || data?.detail_work)\n    if (!detail) errors.push('detail is required for request form')\n  }\n\n  return { errors }\n}\n\nexport async function GET() {\n  try {\n    const result = await queryRepair(\n      'SELECT * FROM repairrequest ORDER BY created_at DESC'\n    )\n    return NextResponse.json(result.rows)\n  } catch (error) {\n    console.error('Failed to fetch repair requests:', error)\n    return NextResponse.json({ error: \"Failed to fetch repair requests\" }, { status: 500 })\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const data = await request.json()\n    const { asset_id, username, Ref, type_of_work, work, detail_work, formType, img, device_name } = data\n    const { errors } = validateTicketPayload(data)\n    if (errors.length) {\n      return NextResponse.json({ error: errors.join(', ') }, { status: 400 })\n    }\n    \n    console.log('Received ticket data:', data)\n    console.log('Image URL received:', img)\n    \n    // Generate request_id in format IT+YY+MM+NNN (e.g., IT6812001)\n    const now = new Date()\n    const thaiYear = now.getFullYear() + 543 // Convert to Buddhist year\n    const year = thaiYear.toString().slice(-2) // Last 2 digits of Thai year\n    const month = (now.getMonth() + 1).toString().padStart(2, '0')\n    const prefix = `IT${year}${month}`\n    \n    // Get the latest request_id with current month prefix\n    const latestResult = await queryRepair(\n      `SELECT request_id FROM repairrequest \n       WHERE request_id LIKE $1 \n       ORDER BY request_id DESC \n       LIMIT 1`,\n      [`${prefix}%`]\n    )\n    \n    let sequence = 0\n    if (latestResult.rows.length > 0) {\n      // Extract the sequence number from the last request_id\n      const lastId = latestResult.rows[0].request_id\n      const lastSequence = parseInt(lastId.slice(-3))\n      sequence = lastSequence + 1\n    }\n    \n    const request_id = `${prefix}${sequence.toString().padStart(3, '0')}`\n    \n    const imgValue = img || null\n    console.log('Inserting img value:', imgValue)\n    \n    const result = await queryRepair(\n      `INSERT INTO repairrequest (request_id, asset_id, username, \"Ref\", \"Status\", type_of_work, work, detail_work, form_type, img, device_name, created_at, updated_at) \n       VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, NOW(), NOW()) \n       RETURNING *`,\n      [request_id, asset_id, username, Ref, 0, type_of_work, work, detail_work, formType || 'repair', imgValue, device_name || null]\n    )\n    \n    console.log('Inserted ticket:', result.rows[0])\n    \n    // ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô LINE Notify\n    const ticket = result.rows[0]\n    if ((formType || 'repair') === 'request') {\n      notifyNewEquipmentRequest({\n        request_id: ticket.request_id,\n        username: ticket.username,\n        equipment: ticket.work,\n        detail: ticket.Ref || ticket.detail_work || '',\n        created_at: ticket.created_at\n      }).catch(error => {\n        console.error('Failed to send LINE equipment notification:', error)\n      })\n    } else {\n      notifyNewRepairRequest({\n        request_id: ticket.request_id,\n        asset_id: ticket.asset_id,\n        username: ticket.username,\n        work: ticket.work,\n        type_of_work: ticket.type_of_work,\n        detail_work: ticket.detail_work,\n        created_at: ticket.created_at\n      }).catch(error => {\n        console.error('Failed to send LINE notification:', error)\n        // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ error ‡∏à‡∏≤‡∏Å LINE ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á ticket\n      })\n    }\n    \n    return NextResponse.json(result.rows[0], { status: 201 })\n  } catch (error) {\n    console.error('Failed to create repair request:', error)\n    return NextResponse.json({ error: \"Failed to create repair request\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}