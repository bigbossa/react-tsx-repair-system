{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Computer/Desktop/pm2_Suacess_Mark1/app/react-tsx-repair-system/lib/db.ts"],"sourcesContent":["import { Pool } from 'pg'\r\n\r\n// User Login Database (useryc)\r\nconsole.log('User Database Configuration:', {\r\n  host: process.env.DBLG_HOST,\r\n  port: process.env.DBLG_PORT,\r\n  database: process.env.DBLG_NAME,\r\n  user: process.env.DBLG_USER,\r\n  passwordSet: !!process.env.DBLG_PASSWORD\r\n})\r\n\r\nconst poolLogin = new Pool({\r\n  host: process.env.DBLG_HOST,\r\n  port: parseInt(process.env.DBLG_PORT || '5432'),\r\n  database: process.env.DBLG_NAME,\r\n  user: process.env.DBLG_USER,\r\n  password: process.env.DBLG_PASSWORD,\r\n  connectionTimeoutMillis: 10000,\r\n  idleTimeoutMillis: 30000,\r\n  max: 10,\r\n})\r\n\r\n// Repair Request Database (RepairRequest)\r\nconsole.log('Repair Database Configuration:', {\r\n  host: process.env.DBRE_HOST,\r\n  port: process.env.DBRE_PORT,\r\n  database: process.env.DBRE_NAME,\r\n  user: process.env.DBRE_USER,\r\n  passwordSet: !!process.env.DBRE_PASSWORD\r\n})\r\n\r\nconst poolRepair = new Pool({\r\n  host: process.env.DBRE_HOST,\r\n  port: parseInt(process.env.DBRE_PORT || '5432'),\r\n  database: process.env.DBRE_NAME,\r\n  user: process.env.DBRE_USER,\r\n  password: process.env.DBRE_PASSWORD,\r\n  connectionTimeoutMillis: 10000,\r\n  idleTimeoutMillis: 30000,\r\n  max: 10,\r\n})\r\n\r\n// Test connections on startup\r\npoolLogin.on('connect', () => {\r\n  console.log('User Database connected successfully')\r\n})\r\n\r\npoolLogin.on('error', (err) => {\r\n  console.error('Unexpected user database error:', err)\r\n})\r\n\r\npoolRepair.on('connect', () => {\r\n  console.log('Repair Database connected successfully')\r\n})\r\n\r\npoolRepair.on('error', (err) => {\r\n  console.error('Unexpected repair database error:', err)\r\n})\r\n\r\nexport async function query(text: string, params?: any[]) {\r\n  const start = Date.now()\r\n  try {\r\n    const res = await poolLogin.query(text, params)\r\n    const duration = Date.now() - start\r\n    console.log('Query executed successfully', { duration, rows: res.rowCount })\r\n    return res\r\n  } catch (error) {\r\n    console.error('Database query error:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\nexport async function queryRepair(text: string, params?: any[]) {\r\n  const start = Date.now()\r\n  try {\r\n    const res = await poolRepair.query(text, params)\r\n    const duration = Date.now() - start\r\n    console.log('Repair DB Query executed successfully', { duration, rows: res.rowCount })\r\n    return res\r\n  } catch (error) {\r\n    console.error('Repair database query error:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\nexport { poolLogin as default, poolRepair }\r\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;;;;AAEA,+BAA+B;AAC/B,QAAQ,GAAG,CAAC,gCAAgC;IAC1C,IAAI;IACJ,IAAI;IACJ,QAAQ;IACR,IAAI;IACJ,aAAa,CAAC;AAChB;AAEA,MAAM,YAAY,IAAI,4GAAI,CAAC;IACzB,IAAI;IACJ,MAAM,SAAS,4CAAyB;IACxC,QAAQ;IACR,IAAI;IACJ,QAAQ;IACR,yBAAyB;IACzB,mBAAmB;IACnB,KAAK;AACP;AAEA,0CAA0C;AAC1C,QAAQ,GAAG,CAAC,kCAAkC;IAC5C,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,UAAU,QAAQ,GAAG,CAAC,SAAS;IAC/B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,aAAa,CAAC,CAAC,QAAQ,GAAG,CAAC,aAAa;AAC1C;AAEA,MAAM,aAAa,IAAI,4GAAI,CAAC;IAC1B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,MAAM,SAAS,QAAQ,GAAG,CAAC,SAAS,IAAI;IACxC,UAAU,QAAQ,GAAG,CAAC,SAAS;IAC/B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,UAAU,QAAQ,GAAG,CAAC,aAAa;IACnC,yBAAyB;IACzB,mBAAmB;IACnB,KAAK;AACP;AAEA,8BAA8B;AAC9B,UAAU,EAAE,CAAC,WAAW;IACtB,QAAQ,GAAG,CAAC;AACd;AAEA,UAAU,EAAE,CAAC,SAAS,CAAC;IACrB,QAAQ,KAAK,CAAC,mCAAmC;AACnD;AAEA,WAAW,EAAE,CAAC,WAAW;IACvB,QAAQ,GAAG,CAAC;AACd;AAEA,WAAW,EAAE,CAAC,SAAS,CAAC;IACtB,QAAQ,KAAK,CAAC,qCAAqC;AACrD;AAEO,eAAe,MAAM,IAAY,EAAE,MAAc;IACtD,MAAM,QAAQ,KAAK,GAAG;IACtB,IAAI;QACF,MAAM,MAAM,MAAM,UAAU,KAAK,CAAC,MAAM;QACxC,MAAM,WAAW,KAAK,GAAG,KAAK;QAC9B,QAAQ,GAAG,CAAC,+BAA+B;YAAE;YAAU,MAAM,IAAI,QAAQ;QAAC;QAC1E,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,MAAM;IACR;AACF;AAEO,eAAe,YAAY,IAAY,EAAE,MAAc;IAC5D,MAAM,QAAQ,KAAK,GAAG;IACtB,IAAI;QACF,MAAM,MAAM,MAAM,WAAW,KAAK,CAAC,MAAM;QACzC,MAAM,WAAW,KAAK,GAAG,KAAK;QAC9B,QAAQ,GAAG,CAAC,yCAAyC;YAAE;YAAU,MAAM,IAAI,QAAQ;QAAC;QACpF,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,MAAM;IACR;AACF"}},
    {"offset": {"line": 161, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Computer/Desktop/pm2_Suacess_Mark1/app/react-tsx-repair-system/app/api/users/import/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { query as dbQuery } from '@/lib/db'\r\n\r\ninterface ImportUser {\r\n  username: string\r\n  password: string\r\n  name: string\r\n  role?: string | number\r\n  site?: string\r\n  department?: string\r\n}\r\n\r\n// POST /api/users/import - Import users จาก Excel\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body = await request.json()\r\n    const { users } = body as { users: ImportUser[] }\r\n\r\n    if (!users || !Array.isArray(users) || users.length === 0) {\r\n      return NextResponse.json(\r\n        { success: false, error: 'ไม่มีข้อมูลผู้ใช้ที่จะ import' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    const results = {\r\n      success: 0,\r\n      failed: 0,\r\n      errors: [] as Array<{ row: number; username: string; error: string }>\r\n    }\r\n\r\n    // Helper function to convert any value to string safely\r\n    const toStr = (val: any): string => {\r\n      if (val === null || val === undefined) return ''\r\n      return String(val).trim()\r\n    }\r\n\r\n    for (let i = 0; i < users.length; i++) {\r\n      const user = users[i]\r\n      const rowNumber = i + 2 // Row 1 is header, data starts from row 2\r\n\r\n      try {\r\n        // Convert all fields to string safely\r\n        const username = toStr(user.username)\r\n        const password = toStr(user.password)\r\n        const name = toStr(user.name)\r\n        const site = toStr(user.site)\r\n        const department = toStr(user.department)\r\n\r\n        // Validate required fields\r\n        if (!username || !password || !name) {\r\n          results.failed++\r\n          results.errors.push({\r\n            row: rowNumber,\r\n            username: username || '(ไม่ระบุ)',\r\n            error: 'ข้อมูลไม่ครบ: ต้องมี username, password, name'\r\n          })\r\n          continue\r\n        }\r\n\r\n        // Convert role to number (0 = Admin, 1 = User)\r\n        let roleValue = 1 // Default to User\r\n        if (user.role !== undefined) {\r\n          if (typeof user.role === 'number') {\r\n            roleValue = user.role === 0 ? 0 : 1\r\n          } else if (typeof user.role === 'string') {\r\n            const roleLower = user.role.toLowerCase().trim()\r\n            if (roleLower === 'admin' || roleLower === '0') {\r\n              roleValue = 0\r\n            }\r\n          }\r\n        }\r\n\r\n        // Check if username already exists\r\n        const checkQuery = `SELECT iduser FROM public.useryc WHERE username = $1`\r\n        const existingUser = await dbQuery(checkQuery, [username])\r\n        \r\n        if (existingUser.rows.length > 0) {\r\n          // Update existing user\r\n          const updateQuery = `\r\n            UPDATE public.useryc \r\n            SET password = $2, usersname = $3, \"Role\" = $4, site = $5, department = $6\r\n            WHERE username = $1\r\n          `\r\n          await dbQuery(updateQuery, [\r\n            username,\r\n            password,\r\n            name,\r\n            roleValue,\r\n            site || null,\r\n            department || null\r\n          ])\r\n        } else {\r\n          // Insert new user\r\n          const insertQuery = `\r\n            INSERT INTO public.useryc (username, password, usersname, \"Role\", site, department)\r\n            VALUES ($1, $2, $3, $4, $5, $6)\r\n          `\r\n          await dbQuery(insertQuery, [\r\n            username,\r\n            password,\r\n            name,\r\n            roleValue,\r\n            site || null,\r\n            department || null\r\n          ])\r\n        }\r\n\r\n        results.success++\r\n      } catch (error: any) {\r\n        results.failed++\r\n        results.errors.push({\r\n          row: rowNumber,\r\n          username: toStr(user.username) || '(ไม่ระบุ)',\r\n          error: error?.message || 'Unknown error'\r\n        })\r\n      }\r\n    }\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      message: `Import สำเร็จ ${results.success} รายการ${results.failed > 0 ? `, ล้มเหลว ${results.failed} รายการ` : ''}`,\r\n      data: results\r\n    })\r\n  } catch (error) {\r\n    console.error('Error importing users:', error)\r\n    return NextResponse.json(\r\n      { \r\n        success: false, \r\n        error: 'Failed to import users',\r\n        details: error instanceof Error ? error.message : 'Unknown error'\r\n      },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}