{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/bigboss/react-tsx-repair-system/react-tsx-repair-system/lib/db.ts"],"sourcesContent":["import { Pool } from 'pg'\r\n\r\n// User Login Database (useryc)\r\nconsole.log('User Database Configuration:', {\r\n  host: process.env.DBLG_HOST,\r\n  port: process.env.DBLG_PORT,\r\n  database: process.env.DBLG_NAME,\r\n  user: process.env.DBLG_USER,\r\n  passwordSet: !!process.env.DBLG_PASSWORD\r\n})\r\n\r\nconst poolLogin = new Pool({\r\n  host: process.env.DBLG_HOST,\r\n  port: parseInt(process.env.DBLG_PORT || '5432'),\r\n  database: process.env.DBLG_NAME,\r\n  user: process.env.DBLG_USER,\r\n  password: process.env.DBLG_PASSWORD,\r\n  connectionTimeoutMillis: 10000,\r\n  idleTimeoutMillis: 30000,\r\n  max: 10,\r\n})\r\n\r\n// Repair Request Database (RepairRequest)\r\nconsole.log('Repair Database Configuration:', {\r\n  host: process.env.DBRE_HOST,\r\n  port: process.env.DBRE_PORT,\r\n  database: process.env.DBRE_NAME,\r\n  user: process.env.DBRE_USER,\r\n  passwordSet: !!process.env.DBRE_PASSWORD\r\n})\r\n\r\nconst poolRepair = new Pool({\r\n  host: process.env.DBRE_HOST,\r\n  port: parseInt(process.env.DBRE_PORT || '5432'),\r\n  database: process.env.DBRE_NAME,\r\n  user: process.env.DBRE_USER,\r\n  password: process.env.DBRE_PASSWORD,\r\n  connectionTimeoutMillis: 10000,\r\n  idleTimeoutMillis: 30000,\r\n  max: 10,\r\n})\r\n\r\n// Test connections on startup\r\npoolLogin.on('connect', () => {\r\n  console.log('User Database connected successfully')\r\n})\r\n\r\npoolLogin.on('error', (err) => {\r\n  console.error('Unexpected user database error:', err)\r\n})\r\n\r\npoolRepair.on('connect', () => {\r\n  console.log('Repair Database connected successfully')\r\n})\r\n\r\npoolRepair.on('error', (err) => {\r\n  console.error('Unexpected repair database error:', err)\r\n})\r\n\r\nexport async function query(text: string, params?: any[]) {\r\n  const start = Date.now()\r\n  try {\r\n    const res = await poolLogin.query(text, params)\r\n    const duration = Date.now() - start\r\n    console.log('Query executed successfully', { duration, rows: res.rowCount })\r\n    return res\r\n  } catch (error) {\r\n    console.error('Database query error:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\nexport async function queryRepair(text: string, params?: any[]) {\r\n  const start = Date.now()\r\n  try {\r\n    const res = await poolRepair.query(text, params)\r\n    const duration = Date.now() - start\r\n    console.log('Repair DB Query executed successfully', { duration, rows: res.rowCount })\r\n    return res\r\n  } catch (error) {\r\n    console.error('Repair database query error:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\nexport { poolLogin as default, poolRepair }\r\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;;;;AAEA,+BAA+B;AAC/B,QAAQ,GAAG,CAAC,gCAAgC;IAC1C,IAAI;IACJ,IAAI;IACJ,QAAQ;IACR,IAAI;IACJ,aAAa,CAAC;AAChB;AAEA,MAAM,YAAY,IAAI,4GAAI,CAAC;IACzB,IAAI;IACJ,MAAM,SAAS,4CAAyB;IACxC,QAAQ;IACR,IAAI;IACJ,QAAQ;IACR,yBAAyB;IACzB,mBAAmB;IACnB,KAAK;AACP;AAEA,0CAA0C;AAC1C,QAAQ,GAAG,CAAC,kCAAkC;IAC5C,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,UAAU,QAAQ,GAAG,CAAC,SAAS;IAC/B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,aAAa,CAAC,CAAC,QAAQ,GAAG,CAAC,aAAa;AAC1C;AAEA,MAAM,aAAa,IAAI,4GAAI,CAAC;IAC1B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,MAAM,SAAS,QAAQ,GAAG,CAAC,SAAS,IAAI;IACxC,UAAU,QAAQ,GAAG,CAAC,SAAS;IAC/B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,UAAU,QAAQ,GAAG,CAAC,aAAa;IACnC,yBAAyB;IACzB,mBAAmB;IACnB,KAAK;AACP;AAEA,8BAA8B;AAC9B,UAAU,EAAE,CAAC,WAAW;IACtB,QAAQ,GAAG,CAAC;AACd;AAEA,UAAU,EAAE,CAAC,SAAS,CAAC;IACrB,QAAQ,KAAK,CAAC,mCAAmC;AACnD;AAEA,WAAW,EAAE,CAAC,WAAW;IACvB,QAAQ,GAAG,CAAC;AACd;AAEA,WAAW,EAAE,CAAC,SAAS,CAAC;IACtB,QAAQ,KAAK,CAAC,qCAAqC;AACrD;AAEO,eAAe,MAAM,IAAY,EAAE,MAAc;IACtD,MAAM,QAAQ,KAAK,GAAG;IACtB,IAAI;QACF,MAAM,MAAM,MAAM,UAAU,KAAK,CAAC,MAAM;QACxC,MAAM,WAAW,KAAK,GAAG,KAAK;QAC9B,QAAQ,GAAG,CAAC,+BAA+B;YAAE;YAAU,MAAM,IAAI,QAAQ;QAAC;QAC1E,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,MAAM;IACR;AACF;AAEO,eAAe,YAAY,IAAY,EAAE,MAAc;IAC5D,MAAM,QAAQ,KAAK,GAAG;IACtB,IAAI;QACF,MAAM,MAAM,MAAM,WAAW,KAAK,CAAC,MAAM;QACzC,MAAM,WAAW,KAAK,GAAG,KAAK;QAC9B,QAAQ,GAAG,CAAC,yCAAyC;YAAE;YAAU,MAAM,IAAI,QAAQ;QAAC;QACpF,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,MAAM;IACR;AACF"}},
    {"offset": {"line": 161, "column": 0}, "map": {"version":3,"sources":["file:///C:/bigboss/react-tsx-repair-system/react-tsx-repair-system/app/api/users/%5Bid%5D/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { query as dbQuery } from '@/lib/db'\r\n\r\n// DELETE /api/users/[id] - ลบผู้ใช้\r\nexport async function DELETE(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const { id } = await params\r\n\r\n    // ตรวจสอบว่าผู้ใช้มีอยู่จริง\r\n    const checkQuery = 'SELECT iduser, usersname FROM public.useryc WHERE iduser = $1'\r\n    const checkResult = await dbQuery(checkQuery, [id])\r\n\r\n    if (checkResult.rows.length === 0) {\r\n      return NextResponse.json(\r\n        { success: false, error: 'ไม่พบผู้ใช้นี้ในระบบ' },\r\n        { status: 404 }\r\n      )\r\n    }\r\n\r\n    // ลบผู้ใช้\r\n    const deleteQuery = 'DELETE FROM public.useryc WHERE iduser = $1 RETURNING iduser'\r\n    const result = await dbQuery(deleteQuery, [id])\r\n\r\n    if (result.rows.length > 0) {\r\n      return NextResponse.json({\r\n        success: true,\r\n        message: 'ลบผู้ใช้เรียบร้อยแล้ว'\r\n      })\r\n    } else {\r\n      return NextResponse.json(\r\n        { success: false, error: 'ไม่สามารถลบผู้ใช้ได้' },\r\n        { status: 500 }\r\n      )\r\n    }\r\n  } catch (error: any) {\r\n    console.error('Error deleting user:', error)\r\n\r\n    // Foreign key constraint error\r\n    if (error?.code === '23503') {\r\n      return NextResponse.json(\r\n        { \r\n          success: false, \r\n          error: 'ไม่สามารถลบผู้ใช้นี้ได้ เนื่องจากมีข้อมูลที่เกี่ยวข้องอยู่ในระบบ' \r\n        },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    return NextResponse.json(\r\n      { \r\n        success: false, \r\n        error: 'เกิดข้อผิดพลาดในการลบผู้ใช้',\r\n        details: error instanceof Error ? error.message : 'Unknown error'\r\n      },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\n// PUT /api/users/[id] - แก้ไขผู้ใช้\r\nexport async function PUT(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const { id } = await params\r\n    const body = await request.json()\r\n    const { usersname, Role, site, department, password } = body\r\n\r\n    // สร้าง query แบบ dynamic\r\n    const updates: string[] = []\r\n    const values: any[] = []\r\n    let paramCount = 1\r\n\r\n    if (usersname !== undefined) {\r\n      updates.push(`usersname = $${paramCount}`)\r\n      values.push(usersname)\r\n      paramCount++\r\n    }\r\n\r\n    if (Role !== undefined) {\r\n      updates.push(`\"Role\" = $${paramCount}`)\r\n      values.push(Role)\r\n      paramCount++\r\n    }\r\n\r\n    if (site !== undefined) {\r\n      updates.push(`site = $${paramCount}`)\r\n      values.push(site)\r\n      paramCount++\r\n    }\r\n\r\n    if (department !== undefined) {\r\n      updates.push(`department = $${paramCount}`)\r\n      values.push(department)\r\n      paramCount++\r\n    }\r\n\r\n    if (password !== undefined && password !== '') {\r\n      updates.push(`password = $${paramCount}`)\r\n      values.push(password)\r\n      paramCount++\r\n    }\r\n\r\n    if (updates.length === 0) {\r\n      return NextResponse.json(\r\n        { success: false, error: 'ไม่มีข้อมูลที่ต้องการอัปเดต' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    values.push(id)\r\n    const query = `\r\n      UPDATE public.useryc \r\n      SET ${updates.join(', ')}\r\n      WHERE iduser = $${paramCount}\r\n      RETURNING iduser, userid, username as user_login, usersname as name, \"Role\", site, department\r\n    `\r\n\r\n    const result = await dbQuery(query, values)\r\n\r\n    if (result.rows.length > 0) {\r\n      return NextResponse.json({\r\n        success: true,\r\n        data: result.rows[0],\r\n        message: 'อัปเดตข้อมูลผู้ใช้เรียบร้อยแล้ว'\r\n      })\r\n    } else {\r\n      return NextResponse.json(\r\n        { success: false, error: 'ไม่พบผู้ใช้นี้ในระบบ' },\r\n        { status: 404 }\r\n      )\r\n    }\r\n  } catch (error) {\r\n    console.error('Error updating user:', error)\r\n    return NextResponse.json(\r\n      { \r\n        success: false, \r\n        error: 'เกิดข้อผิดพลาดในการอัปเดตข้อมูล',\r\n        details: error instanceof Error ? error.message : 'Unknown error'\r\n      },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}