{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Computer/Desktop/pm2_Suacess_Mark1/app/react-tsx-repair-system/lib/db.ts"],"sourcesContent":["import { Pool } from 'pg'\r\n\r\n// User Login Database (useryc)\r\nconsole.log('User Database Configuration:', {\r\n  host: process.env.DBLG_HOST,\r\n  port: process.env.DBLG_PORT,\r\n  database: process.env.DBLG_NAME,\r\n  user: process.env.DBLG_USER,\r\n  passwordSet: !!process.env.DBLG_PASSWORD\r\n})\r\n\r\nconst poolLogin = new Pool({\r\n  host: process.env.DBLG_HOST,\r\n  port: parseInt(process.env.DBLG_PORT || '5432'),\r\n  database: process.env.DBLG_NAME,\r\n  user: process.env.DBLG_USER,\r\n  password: process.env.DBLG_PASSWORD,\r\n  connectionTimeoutMillis: 10000,\r\n  idleTimeoutMillis: 30000,\r\n  max: 10,\r\n})\r\n\r\n// Repair Request Database (RepairRequest)\r\nconsole.log('Repair Database Configuration:', {\r\n  host: process.env.DBRE_HOST,\r\n  port: process.env.DBRE_PORT,\r\n  database: process.env.DBRE_NAME,\r\n  user: process.env.DBRE_USER,\r\n  passwordSet: !!process.env.DBRE_PASSWORD\r\n})\r\n\r\nconst poolRepair = new Pool({\r\n  host: process.env.DBRE_HOST,\r\n  port: parseInt(process.env.DBRE_PORT || '5432'),\r\n  database: process.env.DBRE_NAME,\r\n  user: process.env.DBRE_USER,\r\n  password: process.env.DBRE_PASSWORD,\r\n  connectionTimeoutMillis: 10000,\r\n  idleTimeoutMillis: 30000,\r\n  max: 10,\r\n})\r\n\r\n// Test connections on startup\r\npoolLogin.on('connect', () => {\r\n  console.log('User Database connected successfully')\r\n})\r\n\r\npoolLogin.on('error', (err) => {\r\n  console.error('Unexpected user database error:', err)\r\n})\r\n\r\npoolRepair.on('connect', () => {\r\n  console.log('Repair Database connected successfully')\r\n})\r\n\r\npoolRepair.on('error', (err) => {\r\n  console.error('Unexpected repair database error:', err)\r\n})\r\n\r\nexport async function query(text: string, params?: any[]) {\r\n  const start = Date.now()\r\n  try {\r\n    const res = await poolLogin.query(text, params)\r\n    const duration = Date.now() - start\r\n    console.log('Query executed successfully', { duration, rows: res.rowCount })\r\n    return res\r\n  } catch (error) {\r\n    console.error('Database query error:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\nexport async function queryRepair(text: string, params?: any[]) {\r\n  const start = Date.now()\r\n  try {\r\n    const res = await poolRepair.query(text, params)\r\n    const duration = Date.now() - start\r\n    console.log('Repair DB Query executed successfully', { duration, rows: res.rowCount })\r\n    return res\r\n  } catch (error) {\r\n    console.error('Repair database query error:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\nexport { poolLogin as default, poolRepair }\r\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;;;;AAEA,+BAA+B;AAC/B,QAAQ,GAAG,CAAC,gCAAgC;IAC1C,IAAI;IACJ,IAAI;IACJ,QAAQ;IACR,IAAI;IACJ,aAAa,CAAC;AAChB;AAEA,MAAM,YAAY,IAAI,4GAAI,CAAC;IACzB,IAAI;IACJ,MAAM,SAAS,4CAAyB;IACxC,QAAQ;IACR,IAAI;IACJ,QAAQ;IACR,yBAAyB;IACzB,mBAAmB;IACnB,KAAK;AACP;AAEA,0CAA0C;AAC1C,QAAQ,GAAG,CAAC,kCAAkC;IAC5C,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,UAAU,QAAQ,GAAG,CAAC,SAAS;IAC/B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,aAAa,CAAC,CAAC,QAAQ,GAAG,CAAC,aAAa;AAC1C;AAEA,MAAM,aAAa,IAAI,4GAAI,CAAC;IAC1B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,MAAM,SAAS,QAAQ,GAAG,CAAC,SAAS,IAAI;IACxC,UAAU,QAAQ,GAAG,CAAC,SAAS;IAC/B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,UAAU,QAAQ,GAAG,CAAC,aAAa;IACnC,yBAAyB;IACzB,mBAAmB;IACnB,KAAK;AACP;AAEA,8BAA8B;AAC9B,UAAU,EAAE,CAAC,WAAW;IACtB,QAAQ,GAAG,CAAC;AACd;AAEA,UAAU,EAAE,CAAC,SAAS,CAAC;IACrB,QAAQ,KAAK,CAAC,mCAAmC;AACnD;AAEA,WAAW,EAAE,CAAC,WAAW;IACvB,QAAQ,GAAG,CAAC;AACd;AAEA,WAAW,EAAE,CAAC,SAAS,CAAC;IACtB,QAAQ,KAAK,CAAC,qCAAqC;AACrD;AAEO,eAAe,MAAM,IAAY,EAAE,MAAc;IACtD,MAAM,QAAQ,KAAK,GAAG;IACtB,IAAI;QACF,MAAM,MAAM,MAAM,UAAU,KAAK,CAAC,MAAM;QACxC,MAAM,WAAW,KAAK,GAAG,KAAK;QAC9B,QAAQ,GAAG,CAAC,+BAA+B;YAAE;YAAU,MAAM,IAAI,QAAQ;QAAC;QAC1E,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,MAAM;IACR;AACF;AAEO,eAAe,YAAY,IAAY,EAAE,MAAc;IAC5D,MAAM,QAAQ,KAAK,GAAG;IACtB,IAAI;QACF,MAAM,MAAM,MAAM,WAAW,KAAK,CAAC,MAAM;QACzC,MAAM,WAAW,KAAK,GAAG,KAAK;QAC9B,QAAQ,GAAG,CAAC,yCAAyC;YAAE;YAAU,MAAM,IAAI,QAAQ;QAAC;QACpF,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,MAAM;IACR;AACF"}},
    {"offset": {"line": 161, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Computer/Desktop/pm2_Suacess_Mark1/app/react-tsx-repair-system/app/api/admin-sites/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { queryRepair } from '@/lib/db'\r\n\r\n// สร้างตารางถ้ายังไม่มี\r\nasync function ensureTableExists() {\r\n  const createTableQuery = `\r\n    CREATE TABLE IF NOT EXISTS admin_sites (\r\n      id SERIAL PRIMARY KEY,\r\n      user_id VARCHAR(50) NOT NULL,\r\n      site_code VARCHAR(20) NOT NULL,\r\n      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n      UNIQUE(user_id, site_code)\r\n    )\r\n  `\r\n  await queryRepair(createTableQuery)\r\n}\r\n\r\n// GET /api/admin-sites - ดึงข้อมูลสาขาที่ admin รับผิดชอบ\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    await ensureTableExists()\r\n    \r\n    const { searchParams } = new URL(request.url)\r\n    const userId = searchParams.get('user_id')\r\n    \r\n    let query = 'SELECT * FROM admin_sites'\r\n    const params: any[] = []\r\n    \r\n    if (userId) {\r\n      query += ' WHERE user_id = $1'\r\n      params.push(userId)\r\n    }\r\n    \r\n    query += ' ORDER BY id'\r\n    \r\n    const result = await queryRepair(query, params)\r\n    \r\n    return NextResponse.json({\r\n      success: true,\r\n      data: result.rows\r\n    })\r\n  } catch (error) {\r\n    console.error('Error fetching admin sites:', error)\r\n    return NextResponse.json(\r\n      { success: false, error: 'Failed to fetch admin sites' },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\n// POST /api/admin-sites - เพิ่มสาขาที่ admin รับผิดชอบ\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    await ensureTableExists()\r\n    \r\n    const body = await request.json()\r\n    const { user_id, site_codes } = body\r\n    \r\n    if (!user_id || !Array.isArray(site_codes)) {\r\n      return NextResponse.json(\r\n        { success: false, error: 'user_id and site_codes array are required' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n    \r\n    // ลบสาขาเก่าทั้งหมดของ user นี้\r\n    await queryRepair('DELETE FROM admin_sites WHERE user_id = $1', [user_id])\r\n    \r\n    // เพิ่มสาขาใหม่\r\n    for (const site_code of site_codes) {\r\n      if (site_code && site_code.trim()) {\r\n        await queryRepair(\r\n          'INSERT INTO admin_sites (user_id, site_code) VALUES ($1, $2) ON CONFLICT DO NOTHING',\r\n          [user_id, site_code.trim()]\r\n        )\r\n      }\r\n    }\r\n    \r\n    // ดึงข้อมูลที่เพิ่มแล้ว\r\n    const result = await queryRepair(\r\n      'SELECT * FROM admin_sites WHERE user_id = $1',\r\n      [user_id]\r\n    )\r\n    \r\n    return NextResponse.json({\r\n      success: true,\r\n      data: result.rows\r\n    })\r\n  } catch (error) {\r\n    console.error('Error saving admin sites:', error)\r\n    return NextResponse.json(\r\n      { success: false, error: 'Failed to save admin sites' },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\n// DELETE /api/admin-sites - ลบสาขาที่ admin รับผิดชอบ\r\nexport async function DELETE(request: NextRequest) {\r\n  try {\r\n    const { searchParams } = new URL(request.url)\r\n    const userId = searchParams.get('user_id')\r\n    const siteCode = searchParams.get('site_code')\r\n    \r\n    if (!userId) {\r\n      return NextResponse.json(\r\n        { success: false, error: 'user_id is required' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n    \r\n    let query = 'DELETE FROM admin_sites WHERE user_id = $1'\r\n    const params: any[] = [userId]\r\n    \r\n    if (siteCode) {\r\n      query += ' AND site_code = $2'\r\n      params.push(siteCode)\r\n    }\r\n    \r\n    await queryRepair(query, params)\r\n    \r\n    return NextResponse.json({\r\n      success: true,\r\n      message: 'Deleted successfully'\r\n    })\r\n  } catch (error) {\r\n    console.error('Error deleting admin sites:', error)\r\n    return NextResponse.json(\r\n      { success: false, error: 'Failed to delete admin sites' },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;;;;;;;AAEA,wBAAwB;AACxB,eAAe;IACb,MAAM,mBAAmB,CAAC;;;;;;;;EAQ1B,CAAC;IACD,MAAM,IAAA,qKAAW,EAAC;AACpB;AAGO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM;QAEN,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,SAAS,aAAa,GAAG,CAAC;QAEhC,IAAI,QAAQ;QACZ,MAAM,SAAgB,EAAE;QAExB,IAAI,QAAQ;YACV,SAAS;YACT,OAAO,IAAI,CAAC;QACd;QAEA,SAAS;QAET,MAAM,SAAS,MAAM,IAAA,qKAAW,EAAC,OAAO;QAExC,OAAO,2LAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM,OAAO,IAAI;QACnB;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,OAAO,2LAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,OAAO;QAA8B,GACvD;YAAE,QAAQ;QAAI;IAElB;AACF;AAGO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM;QAEN,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,OAAO,EAAE,UAAU,EAAE,GAAG;QAEhC,IAAI,CAAC,WAAW,CAAC,MAAM,OAAO,CAAC,aAAa;YAC1C,OAAO,2LAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,OAAO;YAA4C,GACrE;gBAAE,QAAQ;YAAI;QAElB;QAEA,gCAAgC;QAChC,MAAM,IAAA,qKAAW,EAAC,8CAA8C;YAAC;SAAQ;QAEzE,gBAAgB;QAChB,KAAK,MAAM,aAAa,WAAY;YAClC,IAAI,aAAa,UAAU,IAAI,IAAI;gBACjC,MAAM,IAAA,qKAAW,EACf,uFACA;oBAAC;oBAAS,UAAU,IAAI;iBAAG;YAE/B;QACF;QAEA,wBAAwB;QACxB,MAAM,SAAS,MAAM,IAAA,qKAAW,EAC9B,gDACA;YAAC;SAAQ;QAGX,OAAO,2LAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM,OAAO,IAAI;QACnB;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,OAAO,2LAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,OAAO;QAA6B,GACtD;YAAE,QAAQ;QAAI;IAElB;AACF;AAGO,eAAe,OAAO,OAAoB;IAC/C,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,SAAS,aAAa,GAAG,CAAC;QAChC,MAAM,WAAW,aAAa,GAAG,CAAC;QAElC,IAAI,CAAC,QAAQ;YACX,OAAO,2LAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,OAAO;YAAsB,GAC/C;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI,QAAQ;QACZ,MAAM,SAAgB;YAAC;SAAO;QAE9B,IAAI,UAAU;YACZ,SAAS;YACT,OAAO,IAAI,CAAC;QACd;QAEA,MAAM,IAAA,qKAAW,EAAC,OAAO;QAEzB,OAAO,2LAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SAAS;QACX;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,OAAO,2LAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,OAAO;QAA+B,GACxD;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}