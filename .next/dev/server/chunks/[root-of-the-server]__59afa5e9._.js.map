{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/bigboss/react-tsx-repair-system/react-tsx-repair-system/lib/db.ts"],"sourcesContent":["import { Pool } from 'pg'\r\n\r\n// User Login Database (useryc)\r\nconsole.log('User Database Configuration:', {\r\n  host: process.env.DBLG_HOST,\r\n  port: process.env.DBLG_PORT,\r\n  database: process.env.DBLG_NAME,\r\n  user: process.env.DBLG_USER,\r\n  passwordSet: !!process.env.DBLG_PASSWORD\r\n})\r\n\r\nconst poolLogin = new Pool({\r\n  host: process.env.DBLG_HOST,\r\n  port: parseInt(process.env.DBLG_PORT || '5432'),\r\n  database: process.env.DBLG_NAME,\r\n  user: process.env.DBLG_USER,\r\n  password: process.env.DBLG_PASSWORD,\r\n  connectionTimeoutMillis: 10000,\r\n  idleTimeoutMillis: 30000,\r\n  max: 10,\r\n})\r\n\r\n// Repair Request Database (RepairRequest)\r\nconsole.log('Repair Database Configuration:', {\r\n  host: process.env.DBRE_HOST,\r\n  port: process.env.DBRE_PORT,\r\n  database: process.env.DBRE_NAME,\r\n  user: process.env.DBRE_USER,\r\n  passwordSet: !!process.env.DBRE_PASSWORD\r\n})\r\n\r\nconst poolRepair = new Pool({\r\n  host: process.env.DBRE_HOST,\r\n  port: parseInt(process.env.DBRE_PORT || '5432'),\r\n  database: process.env.DBRE_NAME,\r\n  user: process.env.DBRE_USER,\r\n  password: process.env.DBRE_PASSWORD,\r\n  connectionTimeoutMillis: 10000,\r\n  idleTimeoutMillis: 30000,\r\n  max: 10,\r\n})\r\n\r\n// Test connections on startup\r\npoolLogin.on('connect', () => {\r\n  console.log('User Database connected successfully')\r\n})\r\n\r\npoolLogin.on('error', (err) => {\r\n  console.error('Unexpected user database error:', err)\r\n})\r\n\r\npoolRepair.on('connect', () => {\r\n  console.log('Repair Database connected successfully')\r\n})\r\n\r\npoolRepair.on('error', (err) => {\r\n  console.error('Unexpected repair database error:', err)\r\n})\r\n\r\nexport async function query(text: string, params?: any[]) {\r\n  const start = Date.now()\r\n  try {\r\n    const res = await poolLogin.query(text, params)\r\n    const duration = Date.now() - start\r\n    console.log('Query executed successfully', { duration, rows: res.rowCount })\r\n    return res\r\n  } catch (error) {\r\n    console.error('Database query error:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\nexport async function queryRepair(text: string, params?: any[]) {\r\n  const start = Date.now()\r\n  try {\r\n    const res = await poolRepair.query(text, params)\r\n    const duration = Date.now() - start\r\n    console.log('Repair DB Query executed successfully', { duration, rows: res.rowCount })\r\n    return res\r\n  } catch (error) {\r\n    console.error('Repair database query error:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\nexport { poolLogin as default, poolRepair }\r\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;;;;AAEA,+BAA+B;AAC/B,QAAQ,GAAG,CAAC,gCAAgC;IAC1C,IAAI;IACJ,IAAI;IACJ,QAAQ;IACR,IAAI;IACJ,aAAa,CAAC;AAChB;AAEA,MAAM,YAAY,IAAI,4GAAI,CAAC;IACzB,IAAI;IACJ,MAAM,SAAS,4CAAyB;IACxC,QAAQ;IACR,IAAI;IACJ,QAAQ;IACR,yBAAyB;IACzB,mBAAmB;IACnB,KAAK;AACP;AAEA,0CAA0C;AAC1C,QAAQ,GAAG,CAAC,kCAAkC;IAC5C,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,UAAU,QAAQ,GAAG,CAAC,SAAS;IAC/B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,aAAa,CAAC,CAAC,QAAQ,GAAG,CAAC,aAAa;AAC1C;AAEA,MAAM,aAAa,IAAI,4GAAI,CAAC;IAC1B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,MAAM,SAAS,QAAQ,GAAG,CAAC,SAAS,IAAI;IACxC,UAAU,QAAQ,GAAG,CAAC,SAAS;IAC/B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,UAAU,QAAQ,GAAG,CAAC,aAAa;IACnC,yBAAyB;IACzB,mBAAmB;IACnB,KAAK;AACP;AAEA,8BAA8B;AAC9B,UAAU,EAAE,CAAC,WAAW;IACtB,QAAQ,GAAG,CAAC;AACd;AAEA,UAAU,EAAE,CAAC,SAAS,CAAC;IACrB,QAAQ,KAAK,CAAC,mCAAmC;AACnD;AAEA,WAAW,EAAE,CAAC,WAAW;IACvB,QAAQ,GAAG,CAAC;AACd;AAEA,WAAW,EAAE,CAAC,SAAS,CAAC;IACtB,QAAQ,KAAK,CAAC,qCAAqC;AACrD;AAEO,eAAe,MAAM,IAAY,EAAE,MAAc;IACtD,MAAM,QAAQ,KAAK,GAAG;IACtB,IAAI;QACF,MAAM,MAAM,MAAM,UAAU,KAAK,CAAC,MAAM;QACxC,MAAM,WAAW,KAAK,GAAG,KAAK;QAC9B,QAAQ,GAAG,CAAC,+BAA+B;YAAE;YAAU,MAAM,IAAI,QAAQ;QAAC;QAC1E,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,MAAM;IACR;AACF;AAEO,eAAe,YAAY,IAAY,EAAE,MAAc;IAC5D,MAAM,QAAQ,KAAK,GAAG;IACtB,IAAI;QACF,MAAM,MAAM,MAAM,WAAW,KAAK,CAAC,MAAM;QACzC,MAAM,WAAW,KAAK,GAAG,KAAK;QAC9B,QAAQ,GAAG,CAAC,yCAAyC;YAAE;YAAU,MAAM,IAAI,QAAQ;QAAC;QACpF,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,MAAM;IACR;AACF"}},
    {"offset": {"line": 159, "column": 0}, "map": {"version":3,"sources":["file:///C:/bigboss/react-tsx-repair-system/react-tsx-repair-system/lib/line-notify.ts"],"sourcesContent":["/**\r\n * LINE Official Account Integration (Messaging API)\r\n * ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô LINE Official Account\r\n */\r\n\r\nconst LINE_MESSAGING_API = 'https://api.line.me/v2/bot/message'\r\n\r\ninterface LineMessageOptions {\r\n  message: string\r\n  imageUrl?: string\r\n  userId?: string // ‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô (optional)\r\n}\r\n\r\ninterface FlexMessage {\r\n  type: string\r\n  altText: string\r\n  contents: any\r\n}\r\n\r\n/**\r\n * ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô\r\n */\r\nfunction createFlexMessage(\r\n  title: string, \r\n  details: { label: string; value: string }[], \r\n  color: string = '#06C755',\r\n  requestId?: string,\r\n  currentStatus?: string\r\n): FlexMessage {\r\n  const contents: any = {\r\n    type: 'bubble',\r\n    header: {\r\n      type: 'box',\r\n      layout: 'vertical',\r\n      contents: [\r\n        {\r\n          type: 'text',\r\n          text: title,\r\n          color: '#ffffff',\r\n          weight: 'bold',\r\n          size: 'lg'\r\n        }\r\n      ],\r\n      backgroundColor: color,\r\n      paddingAll: '15px'\r\n    },\r\n    body: {\r\n      type: 'box',\r\n      layout: 'vertical',\r\n      contents: details.map(detail => ({\r\n        type: 'box',\r\n        layout: 'vertical',\r\n        contents: [\r\n          {\r\n            type: 'text',\r\n            text: detail.label,\r\n            color: '#999999',\r\n            size: 'sm',\r\n            margin: 'md'\r\n          },\r\n          {\r\n            type: 'text',\r\n            text: detail.value,\r\n            color: '#333333',\r\n            size: 'md',\r\n            weight: 'bold',\r\n            wrap: true\r\n          }\r\n        ],\r\n        margin: 'lg'\r\n      })),\r\n      paddingAll: '20px'\r\n    }\r\n  }\r\n\r\n  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ requestId\r\n  if (requestId) {\r\n    const buttons: any[] = []\r\n    \r\n    // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ \"‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£\" (0) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° \"‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô\"\r\n    if (currentStatus === '0') {\r\n      buttons.push({\r\n        type: 'button',\r\n        action: {\r\n          type: 'uri',\r\n          label: '‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô',\r\n          uri: `${process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000'}/dashboard?ticket=${requestId}&action=accept`\r\n        },\r\n        style: 'primary',\r\n        color: '#06C755',\r\n        height: 'sm'\r\n      })\r\n    }\r\n    \r\n    // ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡∏°‡∏≠\r\n    buttons.push({\r\n      type: 'button',\r\n      action: {\r\n        type: 'uri',\r\n        label: 'üëÅÔ∏è ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î',\r\n        uri: `${process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000'}/dashboard?ticket=${requestId}`\r\n      },\r\n      style: 'link',\r\n      height: 'sm'\r\n    })\r\n    \r\n    if (buttons.length > 0) {\r\n      contents.footer = {\r\n        type: 'box',\r\n        layout: 'vertical',\r\n        contents: buttons,\r\n        spacing: 'sm',\r\n        paddingAll: '20px'\r\n      }\r\n    }\r\n  }\r\n\r\n  return {\r\n    type: 'flex',\r\n    altText: title,\r\n    contents\r\n  }\r\n}\r\n\r\n/**\r\n * ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô LINE Official Account (Push Message)\r\n * @param to - User ID ‡∏´‡∏£‡∏∑‡∏≠ Group ID ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á\r\n * @param messages - Array ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á\r\n * @returns Promise<boolean> - ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà\r\n */\r\nasync function sendPushMessage(to: string, messages: any[]): Promise<boolean> {\r\n  const channelAccessToken = process.env.LINE_CHANNEL_ACCESS_TOKEN\r\n\r\n  if (!channelAccessToken) {\r\n    console.warn('LINE_CHANNEL_ACCESS_TOKEN is not configured')\r\n    return false\r\n  }\r\n\r\n  try {\r\n    const response = await fetch(`${LINE_MESSAGING_API}/push`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Authorization': `Bearer ${channelAccessToken}`,\r\n      },\r\n      body: JSON.stringify({\r\n        to,\r\n        messages\r\n      }),\r\n    })\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text()\r\n      console.error('LINE Messaging API error:', response.status, errorText)\r\n      return false\r\n    }\r\n\r\n    console.log('LINE message sent successfully')\r\n    return true\r\n  } catch (error) {\r\n    console.error('Failed to send LINE message:', error)\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ö‡∏ö Broadcast (‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ö Bot)\r\n * @param messages - Array ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á\r\n * @returns Promise<boolean> - ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà\r\n */\r\nasync function sendBroadcastMessage(messages: any[]): Promise<boolean> {\r\n  const channelAccessToken = process.env.LINE_CHANNEL_ACCESS_TOKEN\r\n\r\n  if (!channelAccessToken) {\r\n    console.warn('LINE_CHANNEL_ACCESS_TOKEN is not configured')\r\n    return false\r\n  }\r\n\r\n  try {\r\n    const response = await fetch(`${LINE_MESSAGING_API}/broadcast`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Authorization': `Bearer ${channelAccessToken}`,\r\n      },\r\n      body: JSON.stringify({\r\n        messages\r\n      }),\r\n    })\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text()\r\n      console.error('LINE Broadcast API error:', response.status, errorText)\r\n      return false\r\n    }\r\n\r\n    console.log('LINE broadcast sent successfully')\r\n    return true\r\n  } catch (error) {\r\n    console.error('Failed to send LINE broadcast:', error)\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà\r\n */\r\nexport async function notifyNewRepairRequest(ticket: {\r\n  request_id: string\r\n  asset_id: string\r\n  username: string\r\n  work: string\r\n  type_of_work: string\r\n  detail_work: string\r\n  created_at?: Date\r\n}): Promise<boolean> {\r\n  const dateStr = ticket.created_at \r\n    ? new Date(ticket.created_at).toLocaleString('th-TH', { \r\n        timeZone: 'Asia/Bangkok',\r\n        year: 'numeric',\r\n        month: '2-digit',\r\n        day: '2-digit',\r\n        hour: '2-digit',\r\n        minute: '2-digit'\r\n      })\r\n    : new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })\r\n\r\n  // ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô\r\n  const flexMessage = createFlexMessage(\r\n    'üîî ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà!',\r\n    [\r\n      { label: '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏Ç‡∏≠', value: ticket.request_id },\r\n      { label: '‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á', value: ticket.username },\r\n      { label: '‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô', value: ticket.asset_id },\r\n      { label: '‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô', value: ticket.work },\r\n      { label: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó', value: ticket.type_of_work },\r\n      { label: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', value: ticket.detail_work },\r\n      { label: '‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤', value: dateStr }\r\n    ],\r\n    '#06C755',\r\n    ticket.request_id,\r\n    '0' // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏∑‡∏≠ \"‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£\" (0)\r\n  )\r\n\r\n  // ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö Broadcast (‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ö Bot)\r\n  const adminUserId = process.env.LINE_ADMIN_USER_ID\r\n  \r\n  if (adminUserId) {\r\n    // ‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á Admin ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô\r\n    return sendPushMessage(adminUserId, [flexMessage])\r\n  } else {\r\n    // ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö Broadcast ‡∏ñ‡∏∂‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô\r\n    return sendBroadcastMessage([flexMessage])\r\n  }\r\n}\r\n\r\n/**\r\n * ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå\r\n */\r\nexport async function notifyNewEquipmentRequest(req: {\r\n  request_id: string\r\n  username: string\r\n  equipment: string\r\n  detail: string\r\n  created_at?: Date\r\n}): Promise<boolean> {\r\n  const dateStr = req.created_at \r\n    ? new Date(req.created_at).toLocaleString('th-TH', { \r\n        timeZone: 'Asia/Bangkok',\r\n        year: 'numeric',\r\n        month: '2-digit',\r\n        day: '2-digit',\r\n        hour: '2-digit',\r\n        minute: '2-digit'\r\n      })\r\n    : new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })\r\n\r\n  const flexMessage = createFlexMessage(\r\n    'üßæ ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà',\r\n    [\r\n      { label: '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏Ç‡∏≠', value: req.request_id },\r\n      { label: '‡∏ú‡∏π‡πâ‡∏Ç‡∏≠', value: req.username },\r\n      { label: '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', value: req.equipment || '-' },\r\n      { label: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', value: req.detail || '-' },\r\n      { label: '‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤', value: dateStr }\r\n    ],\r\n    '#0EA5E9', // light blue\r\n    req.request_id,\r\n    '0'\r\n  )\r\n\r\n  const adminUserId = process.env.LINE_ADMIN_USER_ID\r\n\r\n  if (adminUserId) {\r\n    return sendPushMessage(adminUserId, [flexMessage])\r\n  } else {\r\n    return sendBroadcastMessage([flexMessage])\r\n  }\r\n}\r\n\r\n/**\r\n * ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô\r\n */\r\nexport async function notifyStatusChange(ticket: {\r\n  request_id: string\r\n  username: string\r\n  oldStatus: string\r\n  newStatus: string\r\n  lineUserId?: string // User ID ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô\r\n}): Promise<boolean> {\r\n  const statusMap: { [key: string]: string } = {\r\n    '0': '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',\r\n    '1': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',\r\n    '2': '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',\r\n    '3': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',\r\n    '4': '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô'\r\n  }\r\n\r\n  const statusEmoji: { [key: string]: string } = {\r\n    '0': '‚è≥',\r\n    '1': 'üîß',\r\n    '2': '‚úÖ',\r\n    '3': '‚ùå',\r\n    '4': 'üìã'\r\n  }\r\n\r\n  const statusColor: { [key: string]: string } = {\r\n    '0': '#FFA500',\r\n    '1': '#0084FF',\r\n    '2': '#06C755',\r\n    '3': '#999999',\r\n    '4': '#FFD700'\r\n  }\r\n\r\n  const dateStr = new Date().toLocaleString('th-TH', { \r\n    timeZone: 'Asia/Bangkok',\r\n    year: 'numeric',\r\n    month: '2-digit',\r\n    day: '2-digit',\r\n    hour: '2-digit',\r\n    minute: '2-digit'\r\n  })\r\n\r\n  const oldStatusText = statusMap[ticket.oldStatus] || ticket.oldStatus\r\n  const newStatusText = statusMap[ticket.newStatus] || ticket.newStatus\r\n  const emoji = statusEmoji[ticket.newStatus] || 'üîÑ'\r\n  const color = statusColor[ticket.newStatus] || '#0084FF'\r\n\r\n  // ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏° (‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)\r\n  const flexMessage = createFlexMessage(\r\n    `${emoji} ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${newStatusText}`,\r\n    [\r\n      { label: '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏Ç‡∏≠', value: ticket.request_id },\r\n      { label: '‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á', value: ticket.username },\r\n      { label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏°', value: `${statusEmoji[ticket.oldStatus] || ''}  ${oldStatusText}` },\r\n      { label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà', value: `${emoji} ${newStatusText}` },\r\n      { label: '‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤', value: dateStr }\r\n    ],\r\n    color,\r\n    ticket.request_id,\r\n    ticket.newStatus // ‡∏™‡πà‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°\r\n  )\r\n\r\n  // ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö Broadcast (‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô)\r\n  const adminUserId = process.env.LINE_ADMIN_USER_ID\r\n  \r\n  if (ticket.lineUserId) {\r\n    // ‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô\r\n    return sendPushMessage(ticket.lineUserId, [flexMessage])\r\n  } else if (adminUserId) {\r\n    // ‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á Admin\r\n    return sendPushMessage(adminUserId, [flexMessage])\r\n  } else {\r\n    // ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö Broadcast\r\n    return sendBroadcastMessage([flexMessage])\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 515, "column": 0}, "map": {"version":3,"sources":["file:///C:/bigboss/react-tsx-repair-system/react-tsx-repair-system/app/api/tickets/%5Bid%5D/route.ts"],"sourcesContent":["import { queryRepair } from \"@/lib/db\"\nimport { type NextRequest, NextResponse } from \"next/server\"\nimport { notifyStatusChange } from \"@/lib/line-notify\"\n\nexport async function GET(\n  request: NextRequest, \n  context: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id } = await context.params\n    const result = await queryRepair(\n      'SELECT * FROM repairrequest WHERE request_id = $1',\n      [id]\n    )\n    \n    if (result.rows.length === 0) {\n      return NextResponse.json({ error: \"Ticket not found\" }, { status: 404 })\n    }\n    return NextResponse.json(result.rows[0])\n  } catch (error) {\n    console.error('Failed to fetch ticket:', error)\n    return NextResponse.json({ error: \"Failed to fetch ticket\" }, { status: 500 })\n  }\n}\n\nexport async function PUT(\n  request: NextRequest, \n  context: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id } = await context.params\n    const data = await request.json()\n\n    const allowedStatusValues = ['0','1','2','3','4',0,1,2,3,4]\n    \n    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏°)\n    const oldTicketResult = await queryRepair(\n      'SELECT \"Status\", username FROM repairrequest WHERE request_id = $1',\n      [id]\n    )\n    const oldStatus = oldTicketResult.rows.length > 0 ? String(oldTicketResult.rows[0].Status) : null\n    const username = oldTicketResult.rows.length > 0 ? oldTicketResult.rows[0].username : null\n    \n    // Build dynamic update query based on provided fields\n    const updates: string[] = []\n    const values: any[] = []\n    let paramCount = 1\n    \n    // Handle both 'status' and 'Status' for backward compatibility\n    const statusValue = data.Status !== undefined ? data.Status : data.status\n    const newStatus = statusValue !== undefined ? String(statusValue) : null\n    if (statusValue !== undefined && !allowedStatusValues.includes(statusValue)) {\n      return NextResponse.json({ error: 'Invalid status value' }, { status: 400 })\n    }\n    \n    if (statusValue !== undefined) {\n      updates.push(`\\\"Status\\\" = $${paramCount}`)\n      values.push(Number(statusValue))\n      paramCount++\n    }\n    \n    if (data.start_repair !== undefined) {\n      updates.push(`\" start_repair\" = $${paramCount}`)\n      values.push(data.start_repair)\n      paramCount++\n    }\n    \n    if (data.finish_repair !== undefined) {\n      updates.push(`finish_repair = $${paramCount}`)\n      values.push(data.finish_repair)\n      paramCount++\n    }\n    \n    if (data.finish_with !== undefined) {\n      updates.push(`finish_with = $${paramCount}`)\n      values.push(data.finish_with)\n      paramCount++\n    }\n    \n    if (data.cost !== undefined) {\n      updates.push(`cost = $${paramCount}`)\n      values.push(data.cost)\n      paramCount++\n    }\n    \n    if (data.price_type !== undefined) {\n      updates.push(`price_type = $${paramCount}`)\n      values.push(data.price_type)\n      paramCount++\n    }\n    \n    if (data.description_price !== undefined) {\n      updates.push(`description_price = $${paramCount}`)\n      values.push(data.description_price)\n      paramCount++\n    }\n    \n    if (data.total_date !== undefined) {\n      updates.push(`total_date = $${paramCount}`)\n      values.push(data.total_date)\n      paramCount++\n    }\n    \n    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Rep_info (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°) ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ\n    if (data.Rep_info !== undefined) {\n      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô\n      const currentDataResult = await queryRepair(\n        'SELECT \"Rep_info\", \"Re_Rep1\" FROM repairrequest WHERE request_id = $1',\n        [id]\n      )\n      \n      if (currentDataResult.rows.length > 0) {\n        const currentRepInfo = currentDataResult.rows[0].Rep_info\n        const currentReRep1 = currentDataResult.rows[0].Re_Rep1\n        \n        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô Rep_info ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ Re_Rep1 ‡πÅ‡∏•‡∏∞ Re_Rep2\n        if (currentRepInfo && currentRepInfo.trim() !== '') {\n          console.log('Moving repair info history:', {\n            request_id: id,\n            oldRepInfo: currentRepInfo,\n            oldReRep1: currentReRep1,\n            newRepInfo: data.Rep_info\n          })\n          \n          // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô Re_Rep1 ‚Üí Re_Rep2\n          updates.push(`\"Re_Rep2\" = $${paramCount}`)\n          values.push(currentReRep1)\n          paramCount++\n          \n          // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô Rep_info ‡πÄ‡∏î‡∏¥‡∏° ‚Üí Re_Rep1\n          updates.push(`\"Re_Rep1\" = $${paramCount}`)\n          values.push(currentRepInfo)\n          paramCount++\n        }\n      }\n      \n      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á Rep_info\n      updates.push(`\"Rep_info\" = $${paramCount}`)\n      values.push(data.Rep_info)\n      paramCount++\n    }\n    \n    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Comment_re (‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô) ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ\n    if (data.Comment_re !== undefined) {\n      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô\n      const currentCommentResult = await queryRepair(\n        'SELECT \"Comment_re\", \"Comment_re2\" FROM repairrequest WHERE request_id = $1',\n        [id]\n      )\n      \n      if (currentCommentResult.rows.length > 0) {\n        const currentCommentRe = currentCommentResult.rows[0].Comment_re\n        const currentCommentRe2 = currentCommentResult.rows[0].Comment_re2\n        \n        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô Comment_re ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ Comment_re2 ‡πÅ‡∏•‡∏∞ Comment_re3\n        if (currentCommentRe && currentCommentRe.trim() !== '') {\n          console.log('Moving comment history:', {\n            request_id: id,\n            oldCommentRe: currentCommentRe,\n            oldCommentRe2: currentCommentRe2,\n            newCommentRe: data.Comment_re\n          })\n          \n          // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô Comment_re2 ‚Üí Comment_re3\n          updates.push(`\"Comment_re3\" = $${paramCount}`)\n          values.push(currentCommentRe2)\n          paramCount++\n          \n          // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô Comment_re ‡πÄ‡∏î‡∏¥‡∏° ‚Üí Comment_re2\n          updates.push(`\"Comment_re2\" = $${paramCount}`)\n          values.push(currentCommentRe)\n          paramCount++\n        }\n      }\n      \n      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á Comment_re\n      updates.push(`\"Comment_re\" = $${paramCount}`)\n      values.push(data.Comment_re)\n      paramCount++\n    }\n    \n    if (data.cancel_whit !== undefined) {\n      updates.push(`cancel_whit = $${paramCount}`)\n      values.push(data.cancel_whit)\n      paramCount++\n    }\n    \n    if (data.repair_count !== undefined) {\n      updates.push(`repair_count = $${paramCount}`)\n      values.push(data.repair_count)\n      paramCount++\n    }\n    \n    if (data.type_of_work !== undefined) {\n      updates.push(`type_of_work = $${paramCount}`)\n      values.push(data.type_of_work)\n      paramCount++\n    }\n    \n    if (data.work !== undefined) {\n      updates.push(`work = $${paramCount}`)\n      values.push(data.work)\n      paramCount++\n    }\n    \n    if (data.detail_work !== undefined) {\n      updates.push(`detail_work = $${paramCount}`)\n      values.push(data.detail_work)\n      paramCount++\n    }\n    \n    // Always update updated_at\n    updates.push('updated_at = NOW()')\n    \n    if (updates.length === 1) {\n      return NextResponse.json({ error: \"No fields to update\" }, { status: 400 })\n    }\n    \n    values.push(id)\n    \n    const result = await queryRepair(\n      `UPDATE repairrequest \n       SET ${updates.join(', ')} \n       WHERE request_id = $${paramCount} \n       RETURNING *`,\n      values\n    )\n    \n    if (result.rows.length === 0) {\n      return NextResponse.json({ error: \"Ticket not found\" }, { status: 404 })\n    }\n    \n    // ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô\n    if (newStatus && oldStatus && newStatus !== oldStatus && username) {\n      notifyStatusChange({\n        request_id: id,\n        username: username,\n        oldStatus: oldStatus,\n        newStatus: newStatus\n      }).catch(error => {\n        console.error('Failed to send LINE status notification:', error)\n        // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ error ‡∏à‡∏≤‡∏Å LINE ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ticket\n      })\n    }\n    \n    return NextResponse.json(result.rows[0])\n  } catch (error) {\n    console.error('Failed to update ticket:', error)\n    return NextResponse.json({ error: \"Failed to update ticket\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}