{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/bigboss/react-tsx-repair-system/react-tsx-repair-system/lib/db.ts"],"sourcesContent":["import { Pool } from 'pg'\r\n\r\n// User Login Database (useryc)\r\nconsole.log('User Database Configuration:', {\r\n  host: process.env.DBLG_HOST,\r\n  port: process.env.DBLG_PORT,\r\n  database: process.env.DBLG_NAME,\r\n  user: process.env.DBLG_USER,\r\n  passwordSet: !!process.env.DBLG_PASSWORD\r\n})\r\n\r\nconst poolLogin = new Pool({\r\n  host: process.env.DBLG_HOST,\r\n  port: parseInt(process.env.DBLG_PORT || '5432'),\r\n  database: process.env.DBLG_NAME,\r\n  user: process.env.DBLG_USER,\r\n  password: process.env.DBLG_PASSWORD,\r\n  connectionTimeoutMillis: 10000,\r\n  idleTimeoutMillis: 30000,\r\n  max: 10,\r\n})\r\n\r\n// Repair Request Database (RepairRequest)\r\nconsole.log('Repair Database Configuration:', {\r\n  host: process.env.DBRE_HOST,\r\n  port: process.env.DBRE_PORT,\r\n  database: process.env.DBRE_NAME,\r\n  user: process.env.DBRE_USER,\r\n  passwordSet: !!process.env.DBRE_PASSWORD\r\n})\r\n\r\nconst poolRepair = new Pool({\r\n  host: process.env.DBRE_HOST,\r\n  port: parseInt(process.env.DBRE_PORT || '5432'),\r\n  database: process.env.DBRE_NAME,\r\n  user: process.env.DBRE_USER,\r\n  password: process.env.DBRE_PASSWORD,\r\n  connectionTimeoutMillis: 10000,\r\n  idleTimeoutMillis: 30000,\r\n  max: 10,\r\n})\r\n\r\n// Test connections on startup\r\npoolLogin.on('connect', () => {\r\n  console.log('User Database connected successfully')\r\n})\r\n\r\npoolLogin.on('error', (err) => {\r\n  console.error('Unexpected user database error:', err)\r\n})\r\n\r\npoolRepair.on('connect', () => {\r\n  console.log('Repair Database connected successfully')\r\n})\r\n\r\npoolRepair.on('error', (err) => {\r\n  console.error('Unexpected repair database error:', err)\r\n})\r\n\r\nexport async function query(text: string, params?: any[]) {\r\n  const start = Date.now()\r\n  try {\r\n    const res = await poolLogin.query(text, params)\r\n    const duration = Date.now() - start\r\n    console.log('Query executed successfully', { duration, rows: res.rowCount })\r\n    return res\r\n  } catch (error) {\r\n    console.error('Database query error:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\nexport async function queryRepair(text: string, params?: any[]) {\r\n  const start = Date.now()\r\n  try {\r\n    const res = await poolRepair.query(text, params)\r\n    const duration = Date.now() - start\r\n    console.log('Repair DB Query executed successfully', { duration, rows: res.rowCount })\r\n    return res\r\n  } catch (error) {\r\n    console.error('Repair database query error:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\nexport { poolLogin as default, poolRepair }\r\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;;;;AAEA,+BAA+B;AAC/B,QAAQ,GAAG,CAAC,gCAAgC;IAC1C,IAAI;IACJ,IAAI;IACJ,QAAQ;IACR,IAAI;IACJ,aAAa,CAAC;AAChB;AAEA,MAAM,YAAY,IAAI,4GAAI,CAAC;IACzB,IAAI;IACJ,MAAM,SAAS,4CAAyB;IACxC,QAAQ;IACR,IAAI;IACJ,QAAQ;IACR,yBAAyB;IACzB,mBAAmB;IACnB,KAAK;AACP;AAEA,0CAA0C;AAC1C,QAAQ,GAAG,CAAC,kCAAkC;IAC5C,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,UAAU,QAAQ,GAAG,CAAC,SAAS;IAC/B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,aAAa,CAAC,CAAC,QAAQ,GAAG,CAAC,aAAa;AAC1C;AAEA,MAAM,aAAa,IAAI,4GAAI,CAAC;IAC1B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,MAAM,SAAS,QAAQ,GAAG,CAAC,SAAS,IAAI;IACxC,UAAU,QAAQ,GAAG,CAAC,SAAS;IAC/B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC3B,UAAU,QAAQ,GAAG,CAAC,aAAa;IACnC,yBAAyB;IACzB,mBAAmB;IACnB,KAAK;AACP;AAEA,8BAA8B;AAC9B,UAAU,EAAE,CAAC,WAAW;IACtB,QAAQ,GAAG,CAAC;AACd;AAEA,UAAU,EAAE,CAAC,SAAS,CAAC;IACrB,QAAQ,KAAK,CAAC,mCAAmC;AACnD;AAEA,WAAW,EAAE,CAAC,WAAW;IACvB,QAAQ,GAAG,CAAC;AACd;AAEA,WAAW,EAAE,CAAC,SAAS,CAAC;IACtB,QAAQ,KAAK,CAAC,qCAAqC;AACrD;AAEO,eAAe,MAAM,IAAY,EAAE,MAAc;IACtD,MAAM,QAAQ,KAAK,GAAG;IACtB,IAAI;QACF,MAAM,MAAM,MAAM,UAAU,KAAK,CAAC,MAAM;QACxC,MAAM,WAAW,KAAK,GAAG,KAAK;QAC9B,QAAQ,GAAG,CAAC,+BAA+B;YAAE;YAAU,MAAM,IAAI,QAAQ;QAAC;QAC1E,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,MAAM;IACR;AACF;AAEO,eAAe,YAAY,IAAY,EAAE,MAAc;IAC5D,MAAM,QAAQ,KAAK,GAAG;IACtB,IAAI;QACF,MAAM,MAAM,MAAM,WAAW,KAAK,CAAC,MAAM;QACzC,MAAM,WAAW,KAAK,GAAG,KAAK;QAC9B,QAAQ,GAAG,CAAC,yCAAyC;YAAE;YAAU,MAAM,IAAI,QAAQ;QAAC;QACpF,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,MAAM;IACR;AACF"}},
    {"offset": {"line": 161, "column": 0}, "map": {"version":3,"sources":["file:///C:/bigboss/react-tsx-repair-system/react-tsx-repair-system/app/api/feedback/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\r\nimport { query, queryRepair } from \"@/lib/db\"\r\n\r\n// GET - ดึงข้อมูล feedback ทั้งหมดหรือตาม request_id\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const { searchParams } = new URL(request.url)\r\n    const request_id = searchParams.get('request_id')\r\n    \r\n    let result\r\n    if (request_id) {\r\n      // ค้นหาตาม request_id - ใช้ queryRepair เพราะตาราง feedback อยู่ใน database itsupport\r\n      result = await queryRepair(\r\n        `SELECT * FROM feedback WHERE form_name = $1 ORDER BY created_at DESC`,\r\n        [request_id]\r\n      )\r\n    } else {\r\n      // ดึงข้อมูลทั้งหมด\r\n      result = await queryRepair(\r\n        `SELECT * FROM feedback ORDER BY created_at DESC`\r\n      )\r\n    }\r\n    \r\n    return NextResponse.json(result.rows)\r\n  } catch (error) {\r\n    console.error(\"Error fetching feedback:\", error)\r\n    return NextResponse.json(\r\n      { error: \"Failed to fetch feedback\" },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\n// POST - สร้าง feedback ใหม่\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body = await request.json()\r\n    const { request_id, form_status, form_description } = body\r\n\r\n    console.log('=== Feedback API Called ===')\r\n    console.log('Request ID:', request_id)\r\n    console.log('Form Status (Rating):', form_status)\r\n    console.log('Form Description:', form_description)\r\n\r\n    if (!request_id || !form_status) {\r\n      return NextResponse.json(\r\n        { error: \"request_id and form_status are required\" },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    const rating = parseInt(form_status)\r\n    const comment = form_description || ''\r\n\r\n    // ตรวจสอบว่าถ้าประเมินไม่ผ่าน ต้องกรอกเหตุผล\r\n    if (rating < 3 && (!comment || comment.trim() === '')) {\r\n      console.log('ERROR: Comment required for rating < 3')\r\n      return NextResponse.json(\r\n        { error: \"กรุณาระบุเหตุผลที่ประเมินไม่ผ่าน\" },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // บันทึก feedback\r\n    console.log('Inserting feedback to database...')\r\n    \r\n    // เก็บ request_id ใน form_name และ rating ใน form_status\r\n    // ใช้ queryRepair เพราะตาราง feedback อยู่ใน database itsupport\r\n    const result = await queryRepair(\r\n      `INSERT INTO feedback (form_name, form_status, form_description, is_active) \r\n       VALUES ($1, $2, $3, $4) \r\n       RETURNING *`,\r\n      [request_id, form_status, comment || null, true]\r\n    )\r\n    console.log('Feedback inserted successfully')\r\n\r\n    // ถ้าประเมินไม่ผ่าน (rating < 3) เปลี่ยนสถานะกลับไปรอดำเนินการ\r\n    if (rating < 3) {\r\n      console.log('Rating < 3, will move comment history...')\r\n      // ดึงข้อมูล Comment เดิม\r\n      const commentData = await queryRepair(\r\n        `SELECT \"Comment_re\", \"Comment_re2\" FROM repairrequest WHERE request_id = $1`,\r\n        [request_id]\r\n      )\r\n\r\n      const updates: string[] = []\r\n      const values: any[] = []\r\n      let paramCount = 1\r\n\r\n      const newComment = `[${new Date().toISOString().split('T')[0]}] ประเมินไม่ผ่าน (Rating: ${rating}): ${comment}`\r\n\r\n      if (commentData.rows.length > 0) {\r\n        const currentCommentRe = commentData.rows[0].Comment_re\r\n        const currentCommentRe2 = commentData.rows[0].Comment_re2\r\n        \r\n        console.log('=== Moving comment history (like Rep_info) ===')\r\n        console.log('Request ID:', request_id)\r\n        console.log('Old Comment_re:', currentCommentRe)\r\n        console.log('Old Comment_re2:', currentCommentRe2)\r\n        console.log('New Comment:', newComment)\r\n\r\n        // ถ้ามีข้อมูลเดิมใน Comment_re ให้เลื่อนไป Comment_re2 และ Comment_re3\r\n        if (currentCommentRe && currentCommentRe.trim() !== '') {\r\n          // เลื่อน Comment_re2 → Comment_re3\r\n          updates.push(`\"Comment_re3\" = $${paramCount}`)\r\n          values.push(currentCommentRe2)\r\n          paramCount++\r\n          \r\n          // เลื่อน Comment_re เดิม → Comment_re2\r\n          updates.push(`\"Comment_re2\" = $${paramCount}`)\r\n          values.push(currentCommentRe)\r\n          paramCount++\r\n        }\r\n      }\r\n\r\n      // บันทึกข้อมูลใหม่ลง Comment_re\r\n      updates.push(`\"Comment_re\" = $${paramCount}`)\r\n      values.push(newComment)\r\n      paramCount++\r\n\r\n      // เปลี่ยนสถานะเป็น 0 (รอดำเนินการ)\r\n      updates.push(`\"Status\" = $${paramCount}`)\r\n      values.push(0)\r\n      paramCount++\r\n\r\n      // อัปเดต updated_at\r\n      updates.push('updated_at = NOW()')\r\n\r\n      // เพิ่ม request_id เป็น parameter สุดท้าย\r\n      values.push(request_id)\r\n\r\n      // Execute UPDATE\r\n      const updateResult = await queryRepair(\r\n        `UPDATE repairrequest \r\n         SET ${updates.join(', ')} \r\n         WHERE request_id = $${paramCount} \r\n         RETURNING \"Comment_re\", \"Comment_re2\", \"Comment_re3\"`,\r\n        values\r\n      )\r\n\r\n      console.log('=== After update ===')\r\n      if (updateResult.rows.length > 0) {\r\n        console.log('New Comment_re:', updateResult.rows[0].Comment_re)\r\n        console.log('New Comment_re2:', updateResult.rows[0].Comment_re2)\r\n        console.log('New Comment_re3:', updateResult.rows[0].Comment_re3)\r\n      }\r\n      console.log('========================')\r\n    } else {\r\n      // ถ้าประเมินผ่าน (rating >= 3) เปลี่ยนสถานะเป็น \"เสร็จสิ้น\" (status = 2)\r\n      // อัพเดตจะทำใน FeedbackDialog แล้ว ไม่ต้องทำที่นี่\r\n      console.log('Rating >= 3, status will be updated by FeedbackDialog')\r\n    }\r\n\r\n    return NextResponse.json(result.rows[0], { status: 201 })\r\n  } catch (error) {\r\n    console.error(\"Error creating feedback:\", error)\r\n    return NextResponse.json(\r\n      { error: \"Failed to create feedback\" },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}